generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  free
  premium
}

enum DigestFrequency {
  off
  daily
  weekly
}

enum Dimension {
  academic
  social_emotional
  behavioural
  aspirational
  islamic
  physical
}

enum Sentiment {
  positive
  neutral
  needs_attention
}

enum AgeBand {
  early_years
  primary
  upper_primary
  secondary
}

enum Gender {
  male
  female
}

enum GoalStatus {
  active
  completed
  paused
}

enum ShareRole {
  viewer
  contributor
}

enum ShareStatus {
  pending
  accepted
  declined
}

model Parent {
  id               String           @id @default(cuid())
  email            String           @unique
  name             String
  passwordHash     String           @map("password_hash")
  subscriptionTier SubscriptionTier @default(free) @map("subscription_tier")
  digestFrequency  DigestFrequency  @default(off) @map("digest_frequency")
  dailyReminder    Boolean          @default(false) @map("daily_reminder")
  weeklyDigest     Boolean          @default(false) @map("weekly_digest")
  milestoneAlerts  Boolean          @default(false) @map("milestone_alerts")
  resetToken       String?          @map("reset_token")
  resetTokenExp    DateTime?        @map("reset_token_exp")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  children     Child[]
  sessions     Session[]
  familyAccess FamilyAccess[]

  @@index([resetToken])
  @@map("parents")
}

model Child {
  id             String    @id @default(cuid())
  parentId       String    @map("parent_id")
  name           String
  dateOfBirth    DateTime  @map("date_of_birth") @db.Date
  gender         Gender?
  photoUrl       String?   @map("photo_url")
  isDemo         Boolean   @default(false) @map("is_demo")
  medicalNotes   String?   @map("medical_notes") @db.VarChar(1000)
  allergies      String[]  @default([])
  specialNeeds   String?   @map("special_needs") @db.VarChar(500)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  parent       Parent           @relation(fields: [parentId], references: [id], onDelete: Cascade)
  observations Observation[]
  milestones   ChildMilestone[]
  scoreCache   ScoreCache[]
  goals        Goal[]

  @@index([parentId])
  @@map("children")
}

model Observation {
  id         String    @id @default(cuid())
  childId    String    @map("child_id")
  dimension  Dimension
  content    String    @db.VarChar(1000)
  contentAr  String?   @map("content_ar") @db.VarChar(2000)
  sentiment  Sentiment
  observedAt DateTime  @map("observed_at") @db.Date
  tags       String[]  @default([])
  deletedAt  DateTime? @map("deleted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId, dimension])
  @@index([childId, observedAt])
  @@index([childId, deletedAt])
  @@index([childId, deletedAt, dimension])
  @@index([childId, deletedAt, observedAt])
  @@index([childId, dimension, observedAt])
  @@index([tags], type: Gin)
  @@map("observations")
}

model MilestoneDefinition {
  id            String    @id @default(cuid())
  dimension     Dimension
  ageBand       AgeBand   @map("age_band")
  title         String    @db.VarChar(100)
  description   String    @db.VarChar(300)
  guidance      String?   @db.VarChar(500)
  titleAr       String?   @map("title_ar") @db.VarChar(200)
  descriptionAr String?   @map("description_ar") @db.VarChar(600)
  guidanceAr    String?   @map("guidance_ar") @db.VarChar(1000)
  sortOrder     Int       @map("sort_order")

  childMilestones ChildMilestone[]

  @@unique([dimension, ageBand, sortOrder])
  @@index([dimension, ageBand])
  @@map("milestone_definitions")
}

model ChildMilestone {
  id              String    @id @default(cuid())
  childId         String    @map("child_id")
  milestoneId     String    @map("milestone_id")
  achieved        Boolean   @default(false)
  achievedAt      DateTime? @map("achieved_at")
  achievedHistory Json?     @map("achieved_history")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  child     Child               @relation(fields: [childId], references: [id], onDelete: Cascade)
  milestone MilestoneDefinition @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  @@unique([childId, milestoneId])
  @@index([childId])
  @@index([childId, achieved])
  @@index([childId, achieved, achievedAt])
  @@index([milestoneId])
  @@map("child_milestones")
}

model ScoreCache {
  id           String    @id @default(cuid())
  childId      String    @map("child_id")
  dimension    Dimension
  score        Int       @default(0)
  calculatedAt DateTime  @map("calculated_at") @default(now())
  stale        Boolean   @default(true)

  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([childId, dimension])
  @@index([childId, stale])
  @@index([calculatedAt])
  @@map("score_cache")
}

model Goal {
  id          String        @id @default(cuid())
  childId     String        @map("child_id")
  dimension   Dimension
  title       String        @db.VarChar(200)
  description String?       @db.VarChar(500)
  targetDate  DateTime?     @map("target_date") @db.Date
  status      GoalStatus    @default(active)
  templateId  String?       @map("template_id")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  child    Child         @relation(fields: [childId], references: [id], onDelete: Cascade)
  template GoalTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([childId, dimension])
  @@index([childId, status])
  @@index([childId, status, updatedAt])
  @@index([templateId])
  @@map("goals")
}

model GoalTemplate {
  id            String    @id @default(cuid())
  dimension     Dimension
  ageBand       AgeBand   @map("age_band")
  title         String    @db.VarChar(200)
  description   String?   @db.VarChar(500)
  titleAr       String?   @map("title_ar") @db.VarChar(400)
  descriptionAr String?   @map("description_ar") @db.VarChar(1000)
  category      String?   @db.VarChar(50)
  sortOrder     Int       @map("sort_order") @default(0)

  goals Goal[]

  @@unique([dimension, ageBand, sortOrder])
  @@index([dimension, ageBand])
  @@map("goal_templates")
}

model Session {
  id        String   @id @default(cuid())
  parentId  String   @map("parent_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  parent Parent @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([parentId])
  @@index([expiresAt])
  @@index([parentId, expiresAt])
  @@map("sessions")
}

model FamilyAccess {
  id           String      @id @default(cuid())
  parentId     String      @map("parent_id")
  inviteeEmail String      @map("invitee_email")
  inviteeId    String?     @map("invitee_id")
  role         ShareRole   @default(viewer)
  status       ShareStatus @default(pending)
  childIds     String[]    @default([]) @map("child_ids")
  invitedAt    DateTime    @default(now()) @map("invited_at")
  respondedAt  DateTime?   @map("responded_at")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  parent Parent @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([parentId, inviteeEmail])
  @@index([inviteeEmail])
  @@index([inviteeId])
  @@index([parentId])
  @@map("family_access")
}
