openapi: 3.0.3
info:
  title: Pulse API
  description: |
    AI-Powered Developer Intelligence Platform API.

    Pulse connects to GitHub repositories and transforms development activity
    into actionable insights for engineering leaders. This API powers the web
    dashboard, mobile app, and real-time WebSocket feeds.

    ## Authentication

    All endpoints (except `/health`, `/auth/register`, `/auth/login`, `/auth/github`,
    `/auth/github/callback`, `/auth/forgot-password`, `/auth/reset-password`,
    `/auth/verify-email`, and `/webhooks/github`) require a Bearer JWT token.

    ## WebSocket

    Real-time activity is available via WebSocket at `/api/v1/activity/ws?token=<JWT>`.
    See the WebSocket Protocol section in the architecture documentation.

    ## Error Format

    All errors follow RFC 7807 Problem Details:
    ```json
    {
      "type": "https://pulse.dev/errors/not-found",
      "title": "Not Found",
      "status": 404,
      "detail": "Repository with ID 'abc123' was not found.",
      "instance": "/api/v1/repos/abc123"
    }
    ```
  version: 1.0.0
  contact:
    name: ConnectSW
    url: https://connectsw.com
  license:
    name: Proprietary

servers:
  - url: http://localhost:5003/api/v1
    description: Local development
  - url: https://api.pulse.dev/api/v1
    description: Production

tags:
  - name: Auth
    description: Registration, login, OAuth, token management
  - name: Repositories
    description: GitHub repository connection and management
  - name: Activity
    description: Real-time activity feed (REST + WebSocket)
  - name: Velocity
    description: Team velocity metrics (PRs merged, cycle time, review time)
  - name: Quality
    description: Code quality metrics (coverage, PR size, review comments)
  - name: Risk
    description: AI sprint risk scoring and history
  - name: Team
    description: Team management, invitations, RBAC
  - name: Notifications
    description: Push notification preferences and history
  - name: Settings
    description: User profile and account settings
  - name: Webhooks
    description: GitHub webhook receiver
  - name: Overview
    description: Cross-team aggregation (VP view)
  - name: Health
    description: System health check

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token (1-hour lifetime)

  schemas:
    # ──────────────────────────────────
    # Common / Shared
    # ──────────────────────────────────
    Error:
      type: object
      required: [type, title, status, detail]
      properties:
        type:
          type: string
          format: uri
          example: "https://pulse.dev/errors/not-found"
        title:
          type: string
          example: "Not Found"
        status:
          type: integer
          example: 404
        detail:
          type: string
          example: "Repository with ID 'abc123' was not found."
        instance:
          type: string
          example: "/api/v1/repos/abc123"

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 20
        total:
          type: integer
          example: 142
        totalPages:
          type: integer
          example: 8
        hasMore:
          type: boolean
          example: true

    TrendIndicator:
      type: object
      properties:
        direction:
          type: string
          enum: [up, down, flat]
        percentage:
          type: number
          format: float
          example: 12.5
        comparedTo:
          type: string
          example: "4-week average"

    # ──────────────────────────────────
    # Auth
    # ──────────────────────────────────
    RegisterRequest:
      type: object
      required: [email, password, name]
      properties:
        email:
          type: string
          format: email
          example: "alex@acme.com"
        password:
          type: string
          minLength: 8
          example: "SecureP@ss123"
          description: "Min 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special"
        name:
          type: string
          example: "Alex Chen"

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          example: "alex@acme.com"
        password:
          type: string
          example: "SecureP@ss123"

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT access token (1 hour)
        user:
          $ref: '#/components/schemas/User'

    TokenRefreshResponse:
      type: object
      properties:
        token:
          type: string
          description: New JWT access token

    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
          format: email

    ResetPasswordRequest:
      type: object
      required: [token, password]
      properties:
        token:
          type: string
        password:
          type: string
          minLength: 8

    User:
      type: object
      properties:
        id:
          type: string
          example: "clx1abc123"
        email:
          type: string
          format: email
        name:
          type: string
        githubUsername:
          type: string
          nullable: true
        avatarUrl:
          type: string
          format: uri
          nullable: true
        role:
          type: string
          enum: [ADMIN, MEMBER, VIEWER]
        githubConnected:
          type: boolean
        createdAt:
          type: string
          format: date-time

    # ──────────────────────────────────
    # Repository
    # ──────────────────────────────────
    Repository:
      type: object
      properties:
        id:
          type: string
        githubId:
          type: integer
        name:
          type: string
          example: "backend-api"
        fullName:
          type: string
          example: "acme/backend-api"
        organization:
          type: string
          nullable: true
          example: "acme"
        language:
          type: string
          nullable: true
          example: "TypeScript"
        defaultBranch:
          type: string
          example: "main"
        isPrivate:
          type: boolean
        lastActivityAt:
          type: string
          format: date-time
          nullable: true
        connected:
          type: boolean
        syncStatus:
          type: string
          enum: [idle, syncing, complete, error]
        syncProgress:
          type: integer
          minimum: 0
          maximum: 100
          description: "Percentage of historical data ingested"

    AvailableRepository:
      type: object
      properties:
        githubId:
          type: integer
        name:
          type: string
        fullName:
          type: string
        organization:
          type: string
          nullable: true
        language:
          type: string
          nullable: true
        lastActivityAt:
          type: string
          format: date-time
        isPrivate:
          type: boolean

    SyncStatus:
      type: object
      properties:
        repoId:
          type: string
        status:
          type: string
          enum: [idle, syncing, complete, error]
        progress:
          type: integer
        commitsIngested:
          type: integer
        pullRequestsIngested:
          type: integer
        deploymentsIngested:
          type: integer
        startedAt:
          type: string
          format: date-time
          nullable: true
        completedAt:
          type: string
          format: date-time
          nullable: true
        error:
          type: string
          nullable: true

    # ──────────────────────────────────
    # Activity
    # ──────────────────────────────────
    ActivityEvent:
      type: object
      properties:
        id:
          type: string
        eventType:
          type: string
          enum:
            - commit.push
            - pull_request.opened
            - pull_request.closed
            - pull_request.merged
            - pull_request.reviewed
            - deployment.created
            - deployment.success
            - deployment.failure
        repoId:
          type: string
        repoName:
          type: string
        repoFullName:
          type: string
        author:
          type: object
          properties:
            username:
              type: string
            avatarUrl:
              type: string
              format: uri
        title:
          type: string
          description: "Commit message (first 72 chars) or PR title"
        number:
          type: integer
          nullable: true
          description: "PR number (null for commits)"
        branch:
          type: string
          nullable: true
        sha:
          type: string
          nullable: true
          description: "Commit SHA or deployment commit SHA"
        url:
          type: string
          format: uri
          description: "Link to GitHub"
        status:
          type: string
          nullable: true
          enum: [open, approved, merged, closed, success, failure]
        environment:
          type: string
          nullable: true
          enum: [staging, production]
        reviewerUsername:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time

    # ──────────────────────────────────
    # Velocity
    # ──────────────────────────────────
    VelocityOverview:
      type: object
      properties:
        prsMergedThisWeek:
          type: integer
        prsMergedTrend:
          $ref: '#/components/schemas/TrendIndicator'
        medianCycleTimeHours:
          type: number
          format: float
        cycleTimeTrend:
          $ref: '#/components/schemas/TrendIndicator'
        medianReviewTimeHours:
          type: number
          format: float
        reviewTimeTrend:
          $ref: '#/components/schemas/TrendIndicator'
        prsMergedByWeek:
          type: array
          items:
            type: object
            properties:
              weekStart:
                type: string
                format: date
              total:
                type: integer
              byDeveloper:
                type: array
                items:
                  type: object
                  properties:
                    username:
                      type: string
                    count:
                      type: integer

    CycleTimeDetail:
      type: object
      properties:
        medianHours:
          type: number
          format: float
        trend:
          $ref: '#/components/schemas/TrendIndicator'
        targetHours:
          type: number
          format: float
          example: 24
        daily:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              medianHours:
                type: number
                format: float
        slowPRAlert:
          type: boolean
          description: "True if cycle time > 48h for 3+ consecutive days"

    ReviewTimeDetail:
      type: object
      properties:
        medianHours:
          type: number
          format: float
        trend:
          $ref: '#/components/schemas/TrendIndicator'
        daily:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              medianHours:
                type: number
                format: float
        stalledPRs:
          type: array
          description: "PRs open >8h without review"
          items:
            type: object
            properties:
              prNumber:
                type: integer
              title:
                type: string
              author:
                type: string
              hoursWaiting:
                type: number
                format: float
              url:
                type: string
                format: uri

    # ──────────────────────────────────
    # Quality
    # ──────────────────────────────────
    QualityOverview:
      type: object
      properties:
        averagePRSize:
          type: integer
          description: "Average lines changed (additions + deletions)"
        prSizeTrend:
          $ref: '#/components/schemas/TrendIndicator'
        averageReviewComments:
          type: number
          format: float
        reviewCommentsTrend:
          $ref: '#/components/schemas/TrendIndicator'
        mergeWithoutApprovalRate:
          type: number
          format: float
          description: "Percentage (0-100)"
        mergeWithoutApprovalTrend:
          $ref: '#/components/schemas/TrendIndicator'
        mergeWithoutApprovalAlert:
          type: boolean
          description: "True if >10%"

    CoverageDetail:
      type: object
      properties:
        repos:
          type: array
          items:
            type: object
            properties:
              repoId:
                type: string
              repoName:
                type: string
              currentCoverage:
                type: number
                format: float
              coverageAlert:
                type: boolean
                description: "True if <80%"
              dataPoints:
                type: array
                items:
                  type: object
                  properties:
                    date:
                      type: string
                      format: date-time
                    coverage:
                      type: number
                      format: float
                    commitSha:
                      type: string
                    delta:
                      type: number
                      format: float

    # ──────────────────────────────────
    # Risk
    # ──────────────────────────────────
    RiskScore:
      type: object
      properties:
        score:
          type: integer
          minimum: 0
          maximum: 100
        level:
          type: string
          enum: [low, medium, high]
        explanation:
          type: string
          description: "2-4 sentence NL explanation of top 3 factors"
        delta:
          type: integer
          description: "Change from yesterday's score"
        sparkline:
          type: array
          description: "Last 7 days of scores"
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              score:
                type: integer
        calculatedAt:
          type: string
          format: date-time

    RiskFactor:
      type: object
      properties:
        name:
          type: string
          example: "PR Review Backlog"
        value:
          type: string
          example: "5 PRs waiting >24h"
        impactScore:
          type: integer
          minimum: 0
          maximum: 100
        weight:
          type: number
          format: float
          example: 0.20
        trend:
          $ref: '#/components/schemas/TrendIndicator'
        details:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [pr, commit, metric]
              title:
                type: string
              url:
                type: string
                format: uri
              value:
                type: string

    RiskRecommendation:
      type: object
      properties:
        action:
          type: string
          example: "Assign reviewer to PR #142 -- open 52 hours"
        priority:
          type: string
          enum: [high, medium, low]
        relatedFactor:
          type: string
        url:
          type: string
          format: uri
          nullable: true

    RiskHistoryEntry:
      type: object
      properties:
        date:
          type: string
          format: date-time
        score:
          type: integer
        level:
          type: string
          enum: [low, medium, high]
        explanation:
          type: string

    # ──────────────────────────────────
    # Team
    # ──────────────────────────────────
    TeamMember:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        githubUsername:
          type: string
          nullable: true
        avatarUrl:
          type: string
          format: uri
          nullable: true
        role:
          type: string
          enum: [ADMIN, MEMBER, VIEWER]
        joinedAt:
          type: string
          format: date-time

    TeamMemberMetrics:
      type: object
      properties:
        member:
          $ref: '#/components/schemas/TeamMember'
        prsMergedThisWeek:
          type: integer
        prsReviewedThisWeek:
          type: integer
        medianCycleTimeHours:
          type: number
          format: float
        reviewLoadPercentage:
          type: number
          format: float
        activityTimeline:
          type: array
          items:
            $ref: '#/components/schemas/ActivityEvent'

    InviteMemberRequest:
      type: object
      required: [email, role]
      properties:
        email:
          type: string
          format: email
        role:
          type: string
          enum: [ADMIN, MEMBER, VIEWER]

    UpdateRoleRequest:
      type: object
      required: [role]
      properties:
        role:
          type: string
          enum: [ADMIN, MEMBER, VIEWER]

    # ──────────────────────────────────
    # Notifications
    # ──────────────────────────────────
    Notification:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum:
            - pr_review_requested
            - pr_reviewed
            - pr_merged
            - deployment
            - anomaly
            - risk_change
        title:
          type: string
        body:
          type: string
        data:
          type: object
          description: "Deep link data (repoId, prNumber, anomalyType, etc.)"
        read:
          type: boolean
        dismissed:
          type: boolean
        createdAt:
          type: string
          format: date-time

    NotificationPreferences:
      type: object
      properties:
        prReviewRequested:
          type: boolean
        prReviewedMerged:
          type: boolean
        deploymentEvents:
          type: boolean
        anomalyAlerts:
          type: boolean
        riskChanges:
          type: boolean
        quietHoursStart:
          type: string
          pattern: "^([01]\\d|2[0-3]):[0-5]\\d$"
          example: "22:00"
        quietHoursEnd:
          type: string
          pattern: "^([01]\\d|2[0-3]):[0-5]\\d$"
          example: "07:00"
        emailDigest:
          type: string
          enum: [none, daily, weekly]

    # ──────────────────────────────────
    # Settings / Profile
    # ──────────────────────────────────
    UserProfile:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        name:
          type: string
        avatarUrl:
          type: string
          format: uri
          nullable: true
        githubUsername:
          type: string
          nullable: true
        githubConnected:
          type: boolean
        timezone:
          type: string
          example: "America/New_York"
        createdAt:
          type: string
          format: date-time

    UpdateProfileRequest:
      type: object
      properties:
        name:
          type: string
        timezone:
          type: string

    # ──────────────────────────────────
    # Overview (VP view)
    # ──────────────────────────────────
    TeamOverview:
      type: object
      properties:
        teamId:
          type: string
        teamName:
          type: string
        memberCount:
          type: integer
        riskScore:
          type: integer
        riskLevel:
          type: string
          enum: [low, medium, high]
        sprintName:
          type: string
          nullable: true
        prsMergedThisWeek:
          type: integer
        medianCycleTimeHours:
          type: number
          format: float
        healthIndicator:
          type: string
          enum: [healthy, attention, critical]

    # ──────────────────────────────────
    # Health
    # ──────────────────────────────────
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        version:
          type: string
        uptime:
          type: integer
          description: "Uptime in seconds"
        checks:
          type: object
          properties:
            database:
              type: string
              enum: [ok, error]
            redis:
              type: string
              enum: [ok, error, unavailable]
            githubApi:
              type: string
              enum: [ok, rate_limited, error]

  parameters:
    TimeRange:
      name: range
      in: query
      description: "Time range for data"
      schema:
        type: string
        enum: [4w, 8w, 12w, 6m]
        default: 12w
    RepoFilter:
      name: repoId
      in: query
      description: "Filter by repository ID"
      schema:
        type: string
    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  responses:
    Unauthorized:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://pulse.dev/errors/unauthorized"
            title: "Unauthorized"
            status: 401
            detail: "Invalid or expired JWT token."
    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/Error'
              - type: object
                properties:
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        field:
                          type: string
                        message:
                          type: string
    RateLimited:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            type: "https://pulse.dev/errors/rate-limited"
            title: "Too Many Requests"
            status: 429
            detail: "Rate limit exceeded. Try again in 45 seconds."

# ─────────────────────────────────────────
# PATHS
# ─────────────────────────────────────────

paths:
  # ─── Auth (8 endpoints) ───────────────

  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created, verification email sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/RateLimited'

  /auth/login:
    post:
      tags: [Auth]
      summary: Login with email and password
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
          headers:
            Set-Cookie:
              description: HttpOnly refresh token cookie
              schema:
                type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  /auth/github:
    get:
      tags: [Auth]
      summary: Initiate GitHub OAuth flow
      operationId: githubOAuthInit
      description: |
        Redirects the user to GitHub's authorization page.
        Scopes requested: `repo`, `read:org`, `read:user`.
      responses:
        '302':
          description: Redirect to GitHub OAuth authorization page
          headers:
            Location:
              schema:
                type: string
                format: uri

  /auth/github/callback:
    get:
      tags: [Auth]
      summary: GitHub OAuth callback
      operationId: githubOAuthCallback
      description: |
        Handles the OAuth callback from GitHub. Exchanges the authorization code
        for an access token, creates or updates the user account, and redirects
        to the dashboard with a JWT.
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Redirect to dashboard with JWT
          headers:
            Location:
              schema:
                type: string
                format: uri
            Set-Cookie:
              description: HttpOnly refresh token cookie
              schema:
                type: string
        '400':
          description: Invalid state parameter or code exchange failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      operationId: refreshToken
      description: |
        Uses the HttpOnly refresh token cookie to issue a new JWT access token.
      responses:
        '200':
          description: New access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenRefreshResponse'
        '401':
          description: Refresh token invalid or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/forgot-password:
    post:
      tags: [Auth]
      summary: Request password reset
      operationId: forgotPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: Reset email sent (always returns 200 to prevent email enumeration)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "If that email is registered, a reset link has been sent."
        '429':
          $ref: '#/components/responses/RateLimited'

  /auth/reset-password:
    post:
      tags: [Auth]
      summary: Reset password with token
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Password has been reset."
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/verify-email:
    get:
      tags: [Auth]
      summary: Verify email address
      operationId: verifyEmail
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Email verified
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Email verified successfully."
        '400':
          description: Invalid or expired verification token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── Repositories (6 endpoints) ──────

  /repos:
    get:
      tags: [Repositories]
      summary: List connected repositories
      operationId: listConnectedRepos
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Connected repositories
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Repository'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /repos/available:
    get:
      tags: [Repositories]
      summary: List available GitHub repos
      operationId: listAvailableRepos
      description: |
        Returns all repositories the user has access to via their GitHub OAuth token,
        grouped by organization. Cached for 10 minutes.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Available repositories from GitHub
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AvailableRepository'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          description: GitHub account not connected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /repos/{id}:
    get:
      tags: [Repositories]
      summary: Get single repository detail
      operationId: getRepository
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Repository details with metrics summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Repository'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /repos/{id}/connect:
    post:
      tags: [Repositories]
      summary: Start monitoring a repository
      operationId: connectRepository
      description: |
        Registers GitHub webhooks and begins ingesting historical data (last 90 days).
        Returns immediately; ingestion runs in background. Track progress via
        `/repos/{id}/sync-status` or WebSocket.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: GitHub repo ID (from /repos/available)
      responses:
        '202':
          description: Monitoring started, ingestion in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Repository'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Repository already connected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /repos/{id}/disconnect:
    post:
      tags: [Repositories]
      summary: Stop monitoring a repository
      operationId: disconnectRepository
      description: |
        Removes GitHub webhooks and stops data ingestion. Historical data retained
        for 30 days before deletion.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Repository disconnected
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  dataRetainedUntil:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /repos/{id}/sync-status:
    get:
      tags: [Repositories]
      summary: Check ingestion progress
      operationId: getSyncStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Sync status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ─── Activity (1 REST + 1 WebSocket) ──

  /activity:
    get:
      tags: [Activity]
      summary: Get activity feed (paginated)
      operationId: getActivityFeed
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/RepoFilter'
        - name: eventType
          in: query
          schema:
            type: string
            enum: [commit, pull_request, deployment]
        - name: author
          in: query
          schema:
            type: string
          description: GitHub username to filter by
      responses:
        '200':
          description: Activity events
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ActivityEvent'
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /activity/ws:
    get:
      tags: [Activity]
      summary: WebSocket activity stream
      operationId: activityWebSocket
      description: |
        Upgrade to WebSocket for real-time activity events.
        Authentication via JWT in query parameter: `?token=<JWT>`.

        **Protocol**: JSON messages. See architecture docs for full protocol.

        **Client messages**: `subscribe`, `unsubscribe`, `pong`
        **Server messages**: `activity`, `ping`, `sync_progress`, `anomaly`, `risk_update`, `error`

        **Rooms**: `team:{teamId}`, `repo:{repoId}`, `user:{userId}`
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: JWT access token
      responses:
        '101':
          description: WebSocket upgrade successful
        '401':
          description: Invalid or expired token

  # ─── Velocity (3 endpoints) ──────────

  /velocity:
    get:
      tags: [Velocity]
      summary: Get team velocity metrics
      operationId: getVelocityMetrics
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TimeRange'
        - $ref: '#/components/parameters/RepoFilter'
      responses:
        '200':
          description: Velocity overview with weekly breakdown
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VelocityOverview'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /velocity/cycle-time:
    get:
      tags: [Velocity]
      summary: Get cycle time detail
      operationId: getCycleTimeDetail
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TimeRange'
        - $ref: '#/components/parameters/RepoFilter'
      responses:
        '200':
          description: Daily cycle time data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CycleTimeDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /velocity/review-time:
    get:
      tags: [Velocity]
      summary: Get review time detail
      operationId: getReviewTimeDetail
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TimeRange'
        - $ref: '#/components/parameters/RepoFilter'
      responses:
        '200':
          description: Daily review time with stalled PR list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewTimeDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ─── Quality (2 endpoints) ───────────

  /quality:
    get:
      tags: [Quality]
      summary: Get code quality metrics
      operationId: getQualityMetrics
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TimeRange'
        - $ref: '#/components/parameters/RepoFilter'
      responses:
        '200':
          description: Quality overview (PR size, review comments, merge-without-approval)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QualityOverview'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /quality/coverage:
    get:
      tags: [Quality]
      summary: Get test coverage trends
      operationId: getCoverageTrends
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TimeRange'
        - $ref: '#/components/parameters/RepoFilter'
      responses:
        '200':
          description: Coverage data per repo over time
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoverageDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ─── Risk (3 endpoints) ──────────────

  /risk:
    get:
      tags: [Risk]
      summary: Get current sprint risk score
      operationId: getRiskScore
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Current risk score with explanation and sparkline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskScore'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risk/history:
    get:
      tags: [Risk]
      summary: Get risk score history
      operationId: getRiskHistory
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TimeRange'
      responses:
        '200':
          description: Historical risk scores
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RiskHistoryEntry'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /risk/factors:
    get:
      tags: [Risk]
      summary: Get risk factor breakdown
      operationId: getRiskFactors
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Individual risk factors with impact scores and recommendations
          content:
            application/json:
              schema:
                type: object
                properties:
                  factors:
                    type: array
                    items:
                      $ref: '#/components/schemas/RiskFactor'
                  recommendations:
                    type: array
                    items:
                      $ref: '#/components/schemas/RiskRecommendation'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ─── Team (5 endpoints) ──────────────

  /team:
    get:
      tags: [Team]
      summary: List team members
      operationId: listTeamMembers
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Team members with basic info
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TeamMember'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /team/{id}:
    get:
      tags: [Team]
      summary: Get individual member metrics
      operationId: getTeamMemberMetrics
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/TimeRange'
      responses:
        '200':
          description: Member metrics (PRs authored, reviewed, cycle time, activity timeline)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamMemberMetrics'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Team]
      summary: Remove team member
      operationId: removeTeamMember
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Member removed
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /team/invite:
    post:
      tags: [Team]
      summary: Invite team member
      operationId: inviteTeamMember
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InviteMemberRequest'
      responses:
        '201':
          description: Invitation sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  inviteId:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: User already a member
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /team/{id}/role:
    patch:
      tags: [Team]
      summary: Update member role
      operationId: updateMemberRole
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRoleRequest'
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TeamMember'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ─── Notifications (4 endpoints) ─────

  /notifications:
    get:
      tags: [Notifications]
      summary: Get notification history
      operationId: listNotifications
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: unreadOnly
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Notification list (last 30 days)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notification'
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
                  unreadCount:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /notifications/preferences:
    get:
      tags: [Notifications]
      summary: Get notification preferences
      operationId: getNotificationPreferences
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Current notification preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationPreferences'
        '401':
          $ref: '#/components/responses/Unauthorized'
    put:
      tags: [Notifications]
      summary: Update notification preferences
      operationId: updateNotificationPreferences
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationPreferences'
      responses:
        '200':
          description: Preferences updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationPreferences'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'

  /notifications/{id}/dismiss:
    post:
      tags: [Notifications]
      summary: Dismiss a notification
      operationId: dismissNotification
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Notification dismissed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ─── Settings (2 endpoints) ──────────

  /settings/profile:
    get:
      tags: [Settings]
      summary: Get user profile
      operationId: getUserProfile
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'
    put:
      tags: [Settings]
      summary: Update user profile
      operationId: updateUserProfile
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/ValidationError'

  # ─── Webhooks (1 endpoint) ───────────

  /webhooks/github:
    post:
      tags: [Webhooks]
      summary: GitHub webhook receiver
      operationId: receiveGitHubWebhook
      description: |
        Receives webhook events from GitHub. Verifies HMAC-SHA256 signature
        in `X-Hub-Signature-256` header. Processes event types: `push`,
        `pull_request`, `deployment`, `deployment_status`, `check_run`.
      parameters:
        - name: X-GitHub-Event
          in: header
          required: true
          schema:
            type: string
            enum: [push, pull_request, deployment, deployment_status, check_run, ping]
        - name: X-Hub-Signature-256
          in: header
          required: true
          schema:
            type: string
        - name: X-GitHub-Delivery
          in: header
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: GitHub webhook payload (varies by event type)
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                    example: true
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Invalid webhook signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── Overview (1 endpoint) ───────────

  /overview/teams:
    get:
      tags: [Overview]
      summary: Cross-team overview (VP view)
      operationId: getTeamsOverview
      description: |
        Returns a summary of all teams the user has access to, with risk scores
        and velocity metrics. Designed for VP/Director level users managing
        multiple teams.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Team overview cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TeamOverview'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ─── Health (1 endpoint) ─────────────

  /health:
    get:
      tags: [Health]
      summary: System health check
      operationId: healthCheck
      description: |
        Returns the health status of the API and its dependencies.
        No authentication required.
      responses:
        '200':
          description: System healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: System unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
