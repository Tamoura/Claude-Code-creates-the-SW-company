import jsPDF from 'jspdf'

interface MeetingData {
  title: string
  date: string
  duration: number
  participants: Array<{ name: string; role: string }>
  summary: string[]
  actionItems: Array<{
    text: string
    owner: string
    dueDate: string
    timestamp: string
  }>
  keyMoments: Array<{
    timestamp: string
    type: string
    title: string
    description: string
  }>
  engagementSummary: {
    average: number
    peak: number
    lowest: number
  }
}

export function exportMeetingToPDF(data: MeetingData) {
  const doc = new jsPDF()
  let yPosition = 20

  // Helper function to add text with wrapping
  const addText = (text: string, fontSize: number = 10, isBold: boolean = false) => {
    doc.setFontSize(fontSize)
    if (isBold) {
      doc.setFont('helvetica', 'bold')
    } else {
      doc.setFont('helvetica', 'normal')
    }

    const lines = doc.splitTextToSize(text, 170)
    doc.text(lines, 20, yPosition)
    yPosition += (lines.length * fontSize * 0.5) + 3
  }

  const addSpace = (space: number = 5) => {
    yPosition += space
  }

  const checkPageBreak = (requiredSpace: number = 20) => {
    if (yPosition > 270) {
      doc.addPage()
      yPosition = 20
    }
  }

  // Title
  addText(`MeetingMind Analysis Report`, 18, true)
  addSpace(3)

  // Meeting Info
  addText(data.title, 14, true)
  addSpace(2)
  addText(`Date: ${new Date(data.date).toLocaleDateString()}`)
  addText(`Duration: ${Math.floor(data.duration / 60)} minutes`)
  addText(`Participants: ${data.participants.length}`)
  addSpace(5)

  // Summary Section
  checkPageBreak()
  addText('Meeting Summary', 12, true)
  addSpace(2)
  data.summary.forEach((point, index) => {
    addText(`${index + 1}. ${point}`)
    addSpace(2)
  })
  addSpace(5)

  // Engagement Metrics
  checkPageBreak()
  addText('Engagement Metrics', 12, true)
  addSpace(2)
  addText(`Average Engagement: ${(data.engagementSummary.average * 100).toFixed(0)}%`)
  addText(`Peak Engagement: ${(data.engagementSummary.peak * 100).toFixed(0)}%`)
  addText(`Lowest Engagement: ${(data.engagementSummary.lowest * 100).toFixed(0)}%`)
  addSpace(5)

  // Action Items
  checkPageBreak()
  addText('Action Items', 12, true)
  addSpace(2)
  data.actionItems.forEach((item, index) => {
    checkPageBreak(30)
    addText(`${index + 1}. ${item.text}`, 10, false)
    addText(`   Owner: ${item.owner} | Due: ${new Date(item.dueDate).toLocaleDateString()} | Time: ${item.timestamp}`, 9, false)
    addSpace(3)
  })
  addSpace(5)

  // Key Moments
  checkPageBreak(40)
  addText('Key Moments', 12, true)
  addSpace(2)
  data.keyMoments.slice(0, 5).forEach((moment, index) => {
    checkPageBreak(35)
    addText(`${index + 1}. [${moment.timestamp}] ${moment.title}`, 10, true)
    addText(`   ${moment.description}`, 9, false)
    addSpace(3)
  })

  // Footer
  doc.setFontSize(8)
  doc.setTextColor(128, 128, 128)
  doc.text('Generated by MeetingMind - Multimodal Meeting Intelligence', 20, 285)

  // Save the PDF
  const fileName = `${data.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`
  doc.save(fileName)
}
