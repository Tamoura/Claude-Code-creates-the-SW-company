openapi: 3.0.3
info:
  title: InvoiceForge API
  description: REST API for InvoiceForge - AI-powered invoice generation for freelancers
  version: 1.0.0
  contact:
    name: ConnectSW
servers:
  - url: http://localhost:5004/api
    description: Local development
  - url: https://api.invoiceforge.app/api
    description: Production

tags:
  - name: Auth
    description: Authentication and account management
  - name: Invoices
    description: Invoice CRUD and AI generation
  - name: Clients
    description: Client management
  - name: Users
    description: User profile and subscription
  - name: Webhooks
    description: External service callbacks
  - name: Health
    description: System health checks

paths:
  # ─── Auth ──────────────────────────────────────────────────────────

  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          description: Email already exists

  /auth/login:
    post:
      tags: [Auth]
      summary: Log in with email and password
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
        '401':
          description: Invalid or expired refresh token

  /auth/google:
    post:
      tags: [Auth]
      summary: Authenticate with Google OAuth
      operationId: googleAuth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [idToken]
              properties:
                idToken:
                  type: string
                  description: Google OAuth ID token
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid Google token

  /auth/logout:
    post:
      tags: [Auth]
      summary: Log out and invalidate session
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Logged out successfully
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/forgot-password:
    post:
      tags: [Auth]
      summary: Request password reset email
      operationId: forgotPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Reset email sent (always returns 200)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /auth/reset-password:
    post:
      tags: [Auth]
      summary: Reset password with token
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, password]
              properties:
                token:
                  type: string
                password:
                  type: string
                  minLength: 8
      responses:
        '200':
          description: Password reset successful
        '400':
          description: Invalid or expired token

  # ─── Invoices ──────────────────────────────────────────────────────

  /invoices/generate:
    post:
      tags: [Invoices]
      summary: Generate invoice from natural language (core AI endpoint)
      operationId: generateInvoice
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateInvoiceRequest'
      responses:
        '201':
          description: Invoice generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '400':
          description: Input too ambiguous or missing billable items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIError'
        '402':
          description: Monthly invoice limit reached (free tier)
        '503':
          description: AI service unavailable

  /invoices:
    get:
      tags: [Invoices]
      summary: List invoices for the authenticated user
      operationId: listInvoices
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, sent, paid, overdue]
        - name: search
          in: query
          schema:
            type: string
          description: Search by client name or invoice number
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            minimum: 1
            maximum: 100
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [createdAt, dueDate, total]
            default: createdAt
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Invoice list with pagination and summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /invoices/{id}:
    get:
      tags: [Invoices]
      summary: Get a single invoice with line items
      operationId: getInvoice
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Invoice details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Invoices]
      summary: Update an invoice
      operationId: updateInvoice
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateInvoiceRequest'
      responses:
        '200':
          description: Invoice updated with recalculated totals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Invoices]
      summary: Delete a draft invoice
      operationId: deleteInvoice
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '204':
          description: Invoice deleted
        '403':
          description: Cannot delete non-draft invoices
        '404':
          $ref: '#/components/responses/NotFound'

  /invoices/{id}/send:
    post:
      tags: [Invoices]
      summary: Mark invoice as sent and generate shareable link
      operationId: sendInvoice
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Invoice marked as sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [sent]
                  shareableLink:
                    type: string
                    format: uri
        '400':
          description: Invoice already sent or paid
        '404':
          $ref: '#/components/responses/NotFound'

  /invoices/{id}/pdf:
    get:
      tags: [Invoices]
      summary: Download invoice as PDF
      operationId: getInvoicePdf
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'

  /invoices/{id}/payment-link:
    post:
      tags: [Invoices]
      summary: Create Stripe payment link for invoice
      operationId: createPaymentLink
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Payment link created
          content:
            application/json:
              schema:
                type: object
                properties:
                  paymentLink:
                    type: string
                    format: uri
                  stripeSessionId:
                    type: string
        '400':
          description: Stripe account not connected
        '404':
          $ref: '#/components/responses/NotFound'

  /invoices/public/{token}:
    get:
      tags: [Invoices]
      summary: Get invoice for public view (no auth required)
      operationId: getPublicInvoice
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Public invoice view
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicInvoice'
        '404':
          $ref: '#/components/responses/NotFound'

  # ─── Clients ───────────────────────────────────────────────────────

  /clients:
    get:
      tags: [Clients]
      summary: List clients
      operationId: listClients
      security:
        - bearerAuth: []
      parameters:
        - name: search
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Client list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [Clients]
      summary: Create a new client
      operationId: createClient
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateClientRequest'
      responses:
        '201':
          description: Client created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        '400':
          $ref: '#/components/responses/ValidationError'

  /clients/{id}:
    get:
      tags: [Clients]
      summary: Get client with invoice history
      operationId: getClient
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ClientId'
      responses:
        '200':
          description: Client details with invoices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientDetail'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Clients]
      summary: Update client details
      operationId: updateClient
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ClientId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateClientRequest'
      responses:
        '200':
          description: Client updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Clients]
      summary: Delete a client
      operationId: deleteClient
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ClientId'
      responses:
        '204':
          description: Client deleted
        '404':
          $ref: '#/components/responses/NotFound'

  # ─── Users ─────────────────────────────────────────────────────────

  /users/me:
    get:
      tags: [Users]
      summary: Get current user profile
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
    put:
      tags: [Users]
      summary: Update user profile
      operationId: updateCurrentUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          $ref: '#/components/responses/ValidationError'

  /users/me/subscription:
    get:
      tags: [Users]
      summary: Get subscription details and usage
      operationId: getSubscription
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Subscription info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'

  # ─── Webhooks ──────────────────────────────────────────────────────

  /webhooks/stripe:
    post:
      tags: [Webhooks]
      summary: Stripe webhook receiver
      operationId: stripeWebhook
      description: |
        Receives Stripe events. Authenticated via webhook signature,
        not JWT. Handles checkout.session.completed and subscription events.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook received
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
        '400':
          description: Invalid webhook signature

  # ─── Health ────────────────────────────────────────────────────────

  /health:
    get:
      tags: [Health]
      summary: Health check
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheck'

# ═════════════════════════════════════════════════════════════════════

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    InvoiceId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    ClientId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid

  responses:
    Unauthorized:
      description: Missing or invalid authentication token
    NotFound:
      description: Resource not found
    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: array
                items:
                  type: object
                  properties:
                    field:
                      type: string
                    message:
                      type: string

  schemas:
    # ── Auth ──────────────────────────────────────────────────────

    RegisterRequest:
      type: object
      required: [email, password, name]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
          description: "Min 8 chars, 1 uppercase, 1 number"
        name:
          type: string
          minLength: 1
        businessName:
          type: string

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/UserSummary'
        accessToken:
          type: string
        refreshToken:
          type: string

    TokenPair:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string

    # ── User ──────────────────────────────────────────────────────

    UserSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        name:
          type: string

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        name:
          type: string
        businessName:
          type: string
          nullable: true
        subscriptionTier:
          type: string
          enum: [free, pro, team]
        invoiceCountThisMonth:
          type: integer
        invoiceLimitThisMonth:
          type: integer
        stripeConnected:
          type: boolean
        createdAt:
          type: string
          format: date-time

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
        businessName:
          type: string

    Subscription:
      type: object
      properties:
        tier:
          type: string
          enum: [free, pro, team]
        invoicesUsedThisMonth:
          type: integer
        invoicesRemainingThisMonth:
          type: integer
          nullable: true
          description: "null for unlimited (pro/team)"
        resetDate:
          type: string
          format: date-time
        stripeCustomerId:
          type: string
          nullable: true
        stripeSubscriptionId:
          type: string
          nullable: true

    # ── Invoice ───────────────────────────────────────────────────

    GenerateInvoiceRequest:
      type: object
      required: [prompt]
      properties:
        prompt:
          type: string
          minLength: 10
          maxLength: 2000
          description: Natural language description of work performed
        clientId:
          type: string
          format: uuid
          nullable: true
          description: Optional pre-selected client ID

    Invoice:
      type: object
      properties:
        id:
          type: string
          format: uuid
        invoiceNumber:
          type: string
          example: "INV-0003"
        status:
          type: string
          enum: [draft, sent, paid, overdue]
        client:
          $ref: '#/components/schemas/InvoiceClient'
        items:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceItem'
        subtotal:
          type: integer
          description: Amount in cents
        taxRate:
          type: integer
          description: Tax rate in basis points (850 = 8.50%)
        taxAmount:
          type: integer
          description: Tax amount in cents
        total:
          type: integer
          description: Total in cents
        currency:
          type: string
          default: USD
        invoiceDate:
          type: string
          format: date
        dueDate:
          type: string
          format: date
        notes:
          type: string
          nullable: true
        aiPrompt:
          type: string
          nullable: true
        shareToken:
          type: string
          nullable: true
        paymentLink:
          type: string
          format: uri
          nullable: true
        paidAt:
          type: string
          format: date-time
          nullable: true
        sentAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    InvoiceClient:
      type: object
      properties:
        id:
          type: string
          format: uuid
          nullable: true
        name:
          type: string
        email:
          type: string
          nullable: true
        address:
          type: string
          nullable: true
        matched:
          type: boolean
          description: Whether client was auto-matched from saved clients

    InvoiceItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        description:
          type: string
        quantity:
          type: integer
          description: Quantity in smallest unit (e.g., hours)
        unitPrice:
          type: integer
          description: Unit price in cents
        amount:
          type: integer
          description: Line total in cents (quantity * unitPrice)
        sortOrder:
          type: integer

    UpdateInvoiceRequest:
      type: object
      properties:
        clientId:
          type: string
          format: uuid
          nullable: true
        invoiceDate:
          type: string
          format: date
        dueDate:
          type: string
          format: date
        taxRate:
          type: integer
          description: Basis points
        notes:
          type: string
          nullable: true
        items:
          type: array
          description: |
            Full replacement of items. Items with id are updated.
            Items without id are created. Existing items not in
            this array are deleted.
          items:
            type: object
            required: [description, quantity, unitPrice]
            properties:
              id:
                type: string
                format: uuid
                description: Omit for new items
              description:
                type: string
              quantity:
                type: integer
              unitPrice:
                type: integer

    PublicInvoice:
      type: object
      description: Invoice data for public view (no sensitive user data)
      properties:
        invoiceNumber:
          type: string
        status:
          type: string
          enum: [draft, sent, paid, overdue]
        fromBusinessName:
          type: string
          nullable: true
        fromName:
          type: string
        client:
          $ref: '#/components/schemas/InvoiceClient'
        items:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceItem'
        subtotal:
          type: integer
        taxRate:
          type: integer
        taxAmount:
          type: integer
        total:
          type: integer
        currency:
          type: string
        invoiceDate:
          type: string
          format: date
        dueDate:
          type: string
          format: date
        notes:
          type: string
          nullable: true
        paymentLink:
          type: string
          format: uri
          nullable: true

    InvoiceListResponse:
      type: object
      properties:
        invoices:
          type: array
          items:
            $ref: '#/components/schemas/Invoice'
        pagination:
          $ref: '#/components/schemas/Pagination'
        summary:
          type: object
          properties:
            totalOutstanding:
              type: integer
              description: Amount in cents
            totalPaidThisMonth:
              type: integer
              description: Amount in cents
            invoicesCreatedThisMonth:
              type: integer

    AIError:
      type: object
      properties:
        error:
          type: string
          description: Human-readable error message
        missingFields:
          type: array
          items:
            type: string
          description: Fields the AI could not extract

    # ── Client ────────────────────────────────────────────────────

    Client:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
          nullable: true
        address:
          type: string
          nullable: true
        city:
          type: string
          nullable: true
        state:
          type: string
          nullable: true
        zip:
          type: string
          nullable: true
        country:
          type: string
          nullable: true
        phone:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateClientRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
        email:
          type: string
          format: email
        address:
          type: string
        city:
          type: string
        state:
          type: string
        zip:
          type: string
        country:
          type: string
        phone:
          type: string
        notes:
          type: string

    UpdateClientRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
        email:
          type: string
          format: email
        address:
          type: string
        city:
          type: string
        state:
          type: string
        zip:
          type: string
        country:
          type: string
        phone:
          type: string
        notes:
          type: string

    ClientDetail:
      type: object
      properties:
        client:
          $ref: '#/components/schemas/Client'
        invoices:
          type: array
          items:
            $ref: '#/components/schemas/Invoice'

    ClientListResponse:
      type: object
      properties:
        clients:
          type: array
          items:
            $ref: '#/components/schemas/Client'
        pagination:
          $ref: '#/components/schemas/Pagination'

    # ── Shared ────────────────────────────────────────────────────

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    HealthCheck:
      type: object
      properties:
        status:
          type: string
          enum: [ok]
        version:
          type: string
        uptime:
          type: integer
          description: Uptime in seconds
        database:
          type: string
          enum: [connected, disconnected]
