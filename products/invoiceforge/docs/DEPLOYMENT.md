# InvoiceForge Production Deployment

## Architecture

```
                    ┌──────────────┐
                    │   Vercel     │
    Users ─────────>│  (Next.js)   │
                    │  Frontend    │
                    └──────┬───────┘
                           │ HTTPS
                           v
                    ┌──────────────┐     ┌──────────────┐
                    │   Render     │────>│   Render     │
                    │  (Fastify)   │     │ (PostgreSQL) │
                    │  API         │     │  Database    │
                    └──────────────┘     └──────────────┘
```

- **Frontend**: Vercel (Next.js 14, port 3109 in dev)
- **Backend API**: Render Web Service (Fastify, Docker, port 5004)
- **Database**: Render PostgreSQL (Starter plan)

## Prerequisites

- Render account (https://render.com)
- Vercel account (https://vercel.com)
- Stripe account with live API keys
- Anthropic API key for AI invoice generation
- GitHub repository access

## Setup Steps

### 1. Deploy API + Database to Render

#### Option A: Render Blueprint (Recommended)

1. Go to https://render.com/deploy
2. Connect your GitHub repository
3. Render will detect `products/invoiceforge/render.yaml`
4. Click "Apply" to create all services automatically
5. The blueprint provisions:
   - `invoiceforge-api` web service (Docker)
   - `invoiceforge-db` PostgreSQL database
   - Auto-generated JWT secrets
   - DATABASE_URL auto-linked from the database

#### Option B: Manual Setup

1. Create a PostgreSQL database:
   - Name: `invoiceforge-db`
   - Database: `invoiceforge_prod`
   - Plan: Starter
   - Region: Oregon
2. Create a Web Service:
   - Name: `invoiceforge-api`
   - Runtime: Docker
   - Dockerfile Path: `./products/invoiceforge/Dockerfile`
   - Docker Context: `./products/invoiceforge`
   - Plan: Starter
   - Health Check Path: `/api/health`
3. Link the database connection string to `DATABASE_URL`

### 2. Set Manual Environment Variables on Render

These cannot be auto-generated and must be set in the Render
dashboard under the `invoiceforge-api` service:

| Variable | Value |
|----------|-------|
| `ANTHROPIC_API_KEY` | Your Anthropic API key (`sk-ant-api03-...`) |
| `STRIPE_SECRET_KEY` | Your Stripe live secret key (`sk_live_...`) |
| `STRIPE_WEBHOOK_SECRET` | Stripe webhook signing secret (`whsec_...`) |
| `APP_URL` | Your frontend URL (e.g., `https://invoiceforge.app`) |

### 3. Run Initial Database Migration

After the first deploy, open the Render Shell for `invoiceforge-api`:

```bash
npx prisma migrate deploy
```

This applies all migrations from `prisma/migrations/` to the
production database.

### 4. Deploy Frontend to Vercel

1. Go to https://vercel.com/new
2. Import your GitHub repository
3. Set the root directory to `products/invoiceforge/apps/web`
4. Framework Preset: Next.js
5. Set environment variables:

| Variable | Value |
|----------|-------|
| `NEXT_PUBLIC_API_URL` | Render API URL (e.g., `https://invoiceforge-api.onrender.com/api`) |
| `NEXT_PUBLIC_APP_URL` | Vercel URL or custom domain (e.g., `https://invoiceforge.app`) |

6. Deploy

### 5. Configure Stripe Webhook

1. Go to Stripe Dashboard > Developers > Webhooks
2. Add endpoint: `https://<your-render-api-url>/api/webhooks/stripe`
3. Select events to listen for:
   - `checkout.session.completed`
   - `invoice.payment_succeeded`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
4. Copy the webhook signing secret
5. Update `STRIPE_WEBHOOK_SECRET` in Render dashboard

### 6. Configure GitHub Secrets for CI/CD

In your GitHub repository settings, add these secrets:

| Secret | Description |
|--------|-------------|
| `RENDER_DEPLOY_HOOK_INVOICEFORGE` | Render deploy hook URL (from Render dashboard > Settings > Deploy Hook) |
| `VERCEL_TOKEN` | Vercel personal access token |
| `VERCEL_ORG_ID` | Your Vercel organization/team ID |
| `VERCEL_PROJECT_ID_INVOICEFORGE` | Vercel project ID for InvoiceForge web |

## Environment Variables Reference

### API (Render)

| Variable | Required | Source | Description |
|----------|----------|--------|-------------|
| `NODE_ENV` | Yes | Auto | Set to `production` |
| `PORT` | Yes | Auto | Set to `5004` |
| `DATABASE_URL` | Yes | Auto | PostgreSQL connection string (from Render DB) |
| `JWT_SECRET` | Yes | Auto | Auto-generated by Render Blueprint |
| `JWT_REFRESH_SECRET` | Yes | Auto | Auto-generated by Render Blueprint |
| `ANTHROPIC_API_KEY` | Yes | Manual | Anthropic API key for AI features |
| `STRIPE_SECRET_KEY` | Yes | Manual | Stripe live secret key |
| `STRIPE_WEBHOOK_SECRET` | Yes | Manual | Stripe webhook signing secret |
| `APP_URL` | Yes | Manual | Frontend URL for CORS and email links |

### Web (Vercel)

| Variable | Required | Description |
|----------|----------|-------------|
| `NEXT_PUBLIC_API_URL` | Yes | Full URL to the API (e.g., `https://invoiceforge-api.onrender.com/api`) |
| `NEXT_PUBLIC_APP_URL` | Yes | Frontend URL (e.g., `https://invoiceforge.app`) |

## CI/CD Pipeline

### Automatic Deployments

Pushes to `main` that modify files under `products/invoiceforge/`
trigger the deploy workflow (`.github/workflows/invoiceforge-deploy.yml`):

1. **Test** - Runs API tests against a PostgreSQL service container
2. **Build** - Builds the Next.js frontend
3. **Deploy API** - Triggers Render deploy via webhook (parallel)
4. **Deploy Web** - Deploys to Vercel via CLI (parallel)

### Manual Deployments

Trigger via GitHub Actions > InvoiceForge Deploy > Run workflow.

### CI-Only (No Deploy)

Pull requests and feature branches run the CI workflow
(`.github/workflows/invoiceforge-ci.yml`) which tests and builds
without deploying.

## Monitoring

### Health Check

The API exposes a health endpoint that Render polls for
zero-downtime deploys:

```
GET /api/health
```

Response (healthy):
```json
{
  "status": "ok",
  "version": "1.0.0",
  "timestamp": "2026-02-01T12:00:00.000Z",
  "database": "connected"
}
```

Response (degraded):
```json
{
  "status": "degraded",
  "version": "1.0.0",
  "timestamp": "2026-02-01T12:00:00.000Z",
  "database": "disconnected"
}
```

### Dashboards

- **Render**: https://dashboard.render.com (API logs, metrics, deploy history)
- **Vercel**: https://vercel.com/dashboard (frontend analytics, build logs)
- **Stripe**: https://dashboard.stripe.com (payment monitoring)

## Database Migrations

### Running Migrations in Production

Connect to the Render Shell or use the Docker image:

```bash
# Via Render Shell
npx prisma migrate deploy

# Via Docker
docker run --env DATABASE_URL=<prod-url> invoiceforge-api npx prisma migrate deploy
```

Migrations are located in `apps/api/prisma/migrations/` and are
included in the Docker image.

### Creating New Migrations

Always create migrations in development first:

```bash
cd products/invoiceforge/apps/api
npx prisma migrate dev --name describe_change
```

Then deploy to production after merging to main.

## Rollback

### API Rollback

Render provides automatic rollback:

- If a deploy fails the health check at `/api/health`, Render
  automatically rolls back to the last healthy deploy
- Manual rollback: Render Dashboard > invoiceforge-api > Deploys >
  select a previous deploy > "Rollback to this deploy"

### Frontend Rollback

Vercel maintains all previous deployments:

- Go to Vercel Dashboard > InvoiceForge > Deployments
- Select the previous deployment
- Click "Promote to Production"

### Database Rollback

Prisma migrations are forward-only. To revert a migration:

1. Create a new migration that undoes the changes
2. Test locally
3. Deploy via the normal pipeline

## Custom Domain Setup

### API Domain (Render)

1. Go to Render Dashboard > invoiceforge-api > Settings
2. Add custom domain: `api.invoiceforge.app`
3. Add the CNAME record to your DNS provider:
   - Type: CNAME
   - Name: `api`
   - Value: `invoiceforge-api.onrender.com`
4. Render automatically provisions an SSL certificate

### Frontend Domain (Vercel)

1. Go to Vercel Dashboard > InvoiceForge > Settings > Domains
2. Add domain: `invoiceforge.app`
3. Add DNS records as instructed by Vercel:
   - For apex domain: A record pointing to Vercel IPs
   - For www: CNAME to `cname.vercel-dns.com`
4. Vercel automatically provisions an SSL certificate

### After Domain Setup

Update these environment variables:
- Render: `APP_URL` = `https://invoiceforge.app`
- Vercel: `NEXT_PUBLIC_API_URL` = `https://api.invoiceforge.app/api`
- Vercel: `NEXT_PUBLIC_APP_URL` = `https://invoiceforge.app`
- Stripe: Update webhook endpoint URL

## SSL

Both Render and Vercel provide automatic SSL certificate provisioning
and renewal via Let's Encrypt. No manual SSL configuration is needed.

## Cost Estimate

| Service | Plan | Monthly Cost |
|---------|------|-------------|
| Render Web Service (API) | Starter | $7/mo |
| Render PostgreSQL | Starter | $7/mo |
| Vercel (Frontend) | Pro / Free | $20/mo or $0 |
| Anthropic API | Usage-based | ~$0.01-0.05 per invoice |
| Stripe | Usage-based | 2.9% + $0.30 per payment |

**Estimated minimum**: $14/mo (Render) + $0-20/mo (Vercel)

Stripe fees are charged to the platform per transaction, not as a
monthly subscription. Anthropic API costs scale with invoice
generation volume.
