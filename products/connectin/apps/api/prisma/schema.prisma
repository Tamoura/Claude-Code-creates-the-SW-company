generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ──────────────────────────────────────────────────

enum UserRole {
  USER
  RECRUITER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
  DELETED
}

enum LanguagePreference {
  AR
  EN
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
  EXPIRED
}

enum TextDirection {
  RTL
  LTR
  AUTO
}

// ─── Users ──────────────────────────────────────────────────

model User {
  id                  String              @id @default(uuid())
  email               String              @unique
  passwordHash        String?             @map("password_hash")
  displayName         String              @map("display_name")
  role                UserRole            @default(USER)
  emailVerified       Boolean             @default(false) @map("email_verified")
  verificationToken   String?             @map("verification_token")
  verificationExpires DateTime?           @map("verification_expires")
  resetToken          String?             @map("reset_token")
  resetTokenExpires   DateTime?           @map("reset_token_expires")
  languagePreference  LanguagePreference  @default(AR) @map("language_preference")
  status              UserStatus          @default(ACTIVE)
  failedLoginAttempts Int                 @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime?           @map("locked_until")
  lastLoginAt         DateTime?           @map("last_login_at")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  profile             Profile?
  sessions            Session[]
  sentConnections     Connection[]        @relation("ConnectionSender")
  receivedConnections Connection[]        @relation("ConnectionReceiver")
  posts               Post[]
  comments            Comment[]
  likes               Like[]
  consents            Consent[]
  jobs                Job[]
  applications        JobApplication[]
  savedJobs           SavedJob[]
  conversationMemberships ConversationMember[]
  sentMessages            Message[]
  notifications           Notification[]
  notificationPreference  NotificationPreference?

  @@index([status, createdAt])
  @@index([verificationToken])
  @@map("users")
}

// ─── Profiles ───────────────────────────────────────────────

model Profile {
  id                String          @id @default(uuid())
  userId            String          @unique @map("user_id")
  headlineAr        String?         @map("headline_ar") @db.VarChar(220)
  headlineEn        String?         @map("headline_en") @db.VarChar(220)
  summaryAr         String?         @map("summary_ar")
  summaryEn         String?         @map("summary_en")
  avatarUrl         String?         @map("avatar_url") @db.VarChar(500)
  location          String?         @db.VarChar(100)
  website           String?         @db.VarChar(255)
  completenessScore Int             @default(0) @map("completeness_score")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  experiences       Experience[]
  educations        Education[]
  profileSkills     ProfileSkill[]

  @@map("profiles")
}

// ─── Experiences ────────────────────────────────────────────

model Experience {
  id          String    @id @default(uuid())
  profileId   String    @map("profile_id")
  company     String    @db.VarChar(200)
  title       String    @db.VarChar(200)
  location    String?   @db.VarChar(100)
  description String?
  startDate   DateTime  @map("start_date") @db.Date
  endDate     DateTime? @map("end_date") @db.Date
  isCurrent   Boolean   @default(false) @map("is_current")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")

  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("experiences")
}

// ─── Education ──────────────────────────────────────────────

model Education {
  id           String    @id @default(uuid())
  profileId    String    @map("profile_id")
  institution  String    @db.VarChar(200)
  degree       String    @db.VarChar(200)
  fieldOfStudy String?   @map("field_of_study") @db.VarChar(200)
  description  String?
  startYear    Int       @map("start_year")
  endYear      Int?      @map("end_year")
  sortOrder    Int       @default(0) @map("sort_order")
  createdAt    DateTime  @default(now()) @map("created_at")

  profile      Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("educations")
}

// ─── Skills ─────────────────────────────────────────────────

model Skill {
  id        String         @id @default(uuid())
  nameEn    String         @unique @map("name_en") @db.VarChar(100)
  nameAr    String?        @map("name_ar") @db.VarChar(100)
  category  String?        @db.VarChar(50)
  createdAt DateTime       @default(now()) @map("created_at")

  profileSkills ProfileSkill[]

  @@map("skills")
}

model ProfileSkill {
  id               String   @id @default(uuid())
  profileId        String   @map("profile_id")
  skillId          String   @map("skill_id")
  endorsementCount Int      @default(0) @map("endorsement_count")
  createdAt        DateTime @default(now()) @map("created_at")

  profile          Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill            Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@map("profile_skills")
}

// ─── Connections ────────────────────────────────────────────

model Connection {
  id            String           @id @default(uuid())
  senderId      String           @map("sender_id")
  receiverId    String           @map("receiver_id")
  status        ConnectionStatus @default(PENDING)
  message       String?          @db.VarChar(300)
  respondedAt   DateTime?        @map("responded_at")
  cooldownUntil DateTime?        @map("cooldown_until")
  expiresAt     DateTime?        @map("expires_at")
  createdAt     DateTime         @default(now()) @map("created_at")

  sender        User             @relation("ConnectionSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver      User             @relation("ConnectionReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId, status])
  @@index([receiverId, status])
  @@index([status, expiresAt])
  @@map("connections")
}

// ─── Sessions ───────────────────────────────────────────────

model Session {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  refreshTokenHash String   @map("refresh_token_hash")
  ipAddress        String?  @map("ip_address")
  userAgent        String?  @map("user_agent")
  expiresAt        DateTime @map("expires_at")
  createdAt        DateTime @default(now()) @map("created_at")

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshTokenHash])
  @@map("sessions")
}

// ─── Posts ───────────────────────────────────────────────────

model Post {
  id            String        @id @default(uuid())
  authorId      String        @map("author_id")
  content       String        @db.VarChar(3000)
  textDirection TextDirection @default(AUTO) @map("text_direction")
  likeCount     Int           @default(0) @map("like_count")
  commentCount  Int           @default(0) @map("comment_count")
  isDeleted     Boolean       @default(false) @map("is_deleted")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  author        User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments      Comment[]
  likes         Like[]

  @@index([authorId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("posts")
}

// ─── Comments ───────────────────────────────────────────────

model Comment {
  id            String        @id @default(uuid())
  postId        String        @map("post_id")
  authorId      String        @map("author_id")
  content       String        @db.VarChar(1000)
  textDirection TextDirection @default(AUTO) @map("text_direction")
  isDeleted     Boolean       @default(false) @map("is_deleted")
  createdAt     DateTime      @default(now()) @map("created_at")

  post          Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        User          @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt(sort: Desc)])
  @@map("comments")
}

// ─── Consents ─────────────────────────────────────────────────

enum ConsentType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  MARKETING_EMAIL
  DATA_PROCESSING
  ANALYTICS
}

model Consent {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  type        ConsentType
  granted     Boolean     @default(false)
  version     String      @db.VarChar(20)
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  grantedAt   DateTime?   @map("granted_at")
  revokedAt   DateTime?   @map("revoked_at")
  createdAt   DateTime    @default(now()) @map("created_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
  @@map("consents")
}

// ─── Likes ──────────────────────────────────────────────────

model Like {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("likes")
}

// ─── Jobs ────────────────────────────────────────────────────

enum WorkType {
  ONSITE
  HYBRID
  REMOTE
}

enum ExperienceLevel {
  ENTRY
  MID
  SENIOR
  LEAD
  EXECUTIVE
}

enum JobStatus {
  OPEN
  CLOSED
  ARCHIVED
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  SHORTLISTED
  REJECTED
  WITHDRAWN
}

model Job {
  id               String          @id @default(uuid())
  recruiterId      String          @map("recruiter_id")
  title            String          @db.VarChar(200)
  company          String          @db.VarChar(200)
  location         String?         @db.VarChar(200)
  workType         WorkType        @default(ONSITE) @map("work_type")
  experienceLevel  ExperienceLevel @default(MID) @map("experience_level")
  description      String          @db.Text
  requirements     String?         @db.Text
  salaryMin        Decimal?        @map("salary_min") @db.Decimal(12, 2)
  salaryMax        Decimal?        @map("salary_max") @db.Decimal(12, 2)
  salaryCurrency   String?         @default("USD") @map("salary_currency") @db.VarChar(10)
  language         String          @default("en") @db.VarChar(5)
  status           JobStatus       @default(OPEN)
  applicantCount   Int             @default(0) @map("applicant_count")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  recruiter        User            @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  applications     JobApplication[]
  savedBy          SavedJob[]

  @@index([recruiterId])
  @@index([status, createdAt])
  @@index([workType])
  @@index([experienceLevel])
  @@map("jobs")
}

model JobApplication {
  id          String            @id @default(uuid())
  jobId       String            @map("job_id")
  applicantId String            @map("applicant_id")
  coverNote   String?           @db.VarChar(500) @map("cover_note")
  status      ApplicationStatus @default(PENDING)
  appliedAt   DateTime          @default(now()) @map("applied_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  job         Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  applicant   User              @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  @@unique([jobId, applicantId])
  @@index([applicantId])
  @@index([jobId])
  @@map("job_applications")
}

model SavedJob {
  id        String   @id @default(uuid())
  jobId     String   @map("job_id")
  userId    String   @map("user_id")
  savedAt   DateTime @default(now()) @map("saved_at")

  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId])
  @@index([userId])
  @@map("saved_jobs")
}

// ─── Messaging ────────────────────────────────────────────────

model Conversation {
  id            String    @id @default(uuid())
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  members  ConversationMember[]
  messages Message[]

  @@map("conversations")
}

model ConversationMember {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  lastReadAt     DateTime? @map("last_read_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_members")
}

model Message {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  senderId       String    @map("sender_id")
  content        String    @db.Text
  isDeleted      Boolean   @default(false) @map("is_deleted")
  readAt         DateTime? @map("read_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId])
  @@map("messages")
}

// ─── Notifications ────────────────────────────────────────────

enum NotificationType {
  CONNECTION_REQUEST
  CONNECTION_ACCEPTED
  MESSAGE
  POST_LIKE
  POST_COMMENT
  JOB_APPLICATION
  SYSTEM
}

enum EmailDigestFrequency {
  OFF
  DAILY
  WEEKLY
}

model Notification {
  id            String           @id @default(uuid())
  userId        String           @map("user_id")
  type          NotificationType
  title         String           @db.VarChar(200)
  message       String?          @db.Text
  referenceId   String?          @map("reference_id")
  referenceType String?          @map("reference_type") @db.VarChar(50)
  isRead        Boolean          @default(false) @map("is_read")
  readAt        DateTime?        @map("read_at")
  createdAt     DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@map("notifications")
}

model NotificationPreference {
  id                 String               @id @default(uuid())
  userId             String               @unique @map("user_id")
  connectionRequests Boolean              @default(true) @map("connection_requests")
  messages           Boolean              @default(true)
  postLikes          Boolean              @default(true) @map("post_likes")
  postComments       Boolean              @default(true) @map("post_comments")
  jobRecommendations Boolean              @default(true) @map("job_recommendations")
  emailDigest        EmailDigestFrequency @default(WEEKLY) @map("email_digest")
  updatedAt          DateTime             @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}
