import { jsPDF } from 'jspdf';
import autoTable from 'jspdf-autotable';

interface InvoiceData {
  id: string;
  paymentId: string;
  amount: string;
  currency: string;
  status: string;
  customer: string;
  date: string;
}

export function generateInvoicePdf(invoice: InvoiceData): void {
  const doc = new jsPDF();

  // Header
  doc.setFontSize(24);
  doc.setTextColor(33, 37, 41);
  doc.text('StableFlow', 14, 22);

  doc.setFontSize(10);
  doc.setTextColor(108, 117, 125);
  doc.text('Stablecoin Payment Gateway', 14, 28);

  // Invoice title
  doc.setFontSize(16);
  doc.setTextColor(33, 37, 41);
  doc.text('INVOICE', 150, 22);

  doc.setFontSize(10);
  doc.setTextColor(108, 117, 125);
  doc.text(invoice.id, 150, 28);

  // Line separator
  doc.setDrawColor(222, 226, 230);
  doc.line(14, 35, 196, 35);

  // Invoice details
  doc.setFontSize(10);
  doc.setTextColor(33, 37, 41);
  const detailsY = 45;
  doc.text('Date:', 14, detailsY);
  doc.setTextColor(108, 117, 125);
  doc.text(invoice.date, 60, detailsY);

  doc.setTextColor(33, 37, 41);
  doc.text('Status:', 14, detailsY + 7);
  doc.setTextColor(108, 117, 125);
  doc.text(invoice.status, 60, detailsY + 7);

  doc.setTextColor(33, 37, 41);
  doc.text('Customer:', 14, detailsY + 14);
  doc.setTextColor(108, 117, 125);
  doc.text(invoice.customer, 60, detailsY + 14);

  doc.setTextColor(33, 37, 41);
  doc.text('Payment ID:', 14, detailsY + 21);
  doc.setTextColor(108, 117, 125);
  doc.text(invoice.paymentId, 60, detailsY + 21);

  // Table
  autoTable(doc, {
    startY: detailsY + 30,
    head: [['Description', 'Currency', 'Amount']],
    body: [['Payment via StableFlow', invoice.currency, invoice.amount]],
    styles: { fontSize: 10, cellPadding: 5 },
    headStyles: { fillColor: [59, 130, 246], textColor: 255 },
    columnStyles: { 2: { halign: 'right', fontStyle: 'bold' } },
  });

  // Total
  const finalY = (doc as any).lastAutoTable?.finalY || detailsY + 60;
  doc.setFontSize(12);
  doc.setTextColor(33, 37, 41);
  doc.text('Total:', 140, finalY + 12);
  doc.setFontSize(14);
  doc.text(invoice.amount, 170, finalY + 12);

  // Footer
  doc.setFontSize(8);
  doc.setTextColor(108, 117, 125);
  doc.text('Generated by StableFlow - Stablecoin Payment Gateway', 14, 280);
  doc.text(`Generated on ${new Date().toLocaleDateString()}`, 14, 285);

  doc.save(`${invoice.id}.pdf`);
}

export function exportAllInvoicesCsv(invoices: InvoiceData[]): void {
  const headers = ['Invoice ID', 'Payment ID', 'Customer', 'Date', 'Amount', 'Currency', 'Status'];
  const rows = invoices.map(inv => [
    inv.id,
    inv.paymentId,
    inv.customer,
    inv.date,
    inv.amount,
    inv.currency,
    inv.status,
  ]);

  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => `"${cell}"`).join(',')),
  ].join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `invoices-${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}
