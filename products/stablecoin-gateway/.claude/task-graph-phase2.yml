# Security Audit Phase 2 - Additional Fixes
# CEO-identified gaps after Phase 1 merge

metadata:
  product: "stablecoin-gateway"
  version: "1.2.0"
  workflow_type: "security-audit-phase2"
  issue_id: "SECURITY-AUDIT-PHASE2-2026-01"
  created_at: "2026-01-29T07:50:00Z"
  updated_at: "2026-01-29T07:50:00Z"
  description: "Fix 4 additional security gaps identified post-Phase1"

tasks:
  # ============================================================================
  # ISSUE 1: WEBHOOK ROUTES MISSING (HIGH PRIORITY)
  # ============================================================================

  - id: "PHASE2-01"
    name: "Implement Webhook CRUD Endpoints"
    description: |
      ISSUE #1: Webhook routes are still missing

      Root cause:
      - apps/api/src/routes/v1/webhooks.ts does NOT exist
      - Cannot create/list/update/delete webhooks
      - Webhook feature is non-functional end-to-end

      Files to create:
      - apps/api/src/routes/v1/webhooks.ts

      Endpoints to implement:
      - POST /v1/webhooks - Create webhook
      - GET /v1/webhooks - List webhooks for user
      - GET /v1/webhooks/:id - Get webhook by ID
      - PATCH /v1/webhooks/:id - Update webhook (url, events, enabled)
      - DELETE /v1/webhooks/:id - Delete webhook

      TDD Approach:
      1. Write failing tests for all CRUD operations
      2. Implement routes with:
         - Authentication (JWT or API key)
         - Validation (URL format, events enum)
         - Ownership checks (user can only manage their webhooks)
         - Secret generation (for webhook signature)
      3. All tests pass

      Integration with WebhookService:
      - Use existing WebhookService for delivery
      - Ensure webhook secret stored securely
      - Document webhook creation flow

      Acceptance Criteria:
      - All 5 CRUD endpoints implemented
      - Tests prove functionality (20+ tests)
      - Webhook secrets generated automatically
      - User can only access their own webhooks
      - API documented
    agent: "backend-engineer"
    depends_on: []
    produces:
      - name: "Webhook Routes"
        type: "file"
        path: "products/stablecoin-gateway/apps/api/src/routes/v1/webhooks.ts"
      - name: "Webhook Tests"
        type: "file"
        path: "products/stablecoin-gateway/apps/api/tests/integration/webhooks.test.ts"
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 90
    acceptance_criteria:
      - "POST /v1/webhooks endpoint implemented"
      - "GET /v1/webhooks endpoint implemented"
      - "GET /v1/webhooks/:id endpoint implemented"
      - "PATCH /v1/webhooks/:id endpoint implemented"
      - "DELETE /v1/webhooks/:id endpoint implemented"
      - "20+ tests passing"
      - "Webhook secrets auto-generated"
      - "Ownership enforced"
    status: "pending"

  # ============================================================================
  # ISSUE 2: SSE AUTH SECURITY CONCERN (MEDIUM PRIORITY)
  # ============================================================================

  - id: "PHASE2-02"
    name: "Improve SSE Auth Security"
    description: |
      ISSUE #2: SSE auth uses query token (security concern)

      Root cause:
      - Token in query string can leak via logs, proxies, analytics
      - Current: ?token=JWT workaround

      Solution options:
      A. Short-lived SSE tokens (15-30 min expiry)
      B. Cookie-based session authentication
      C. One-time-use tokens generated per SSE connection

      Recommended: Option A (short-lived tokens)

      Implementation:
      1. Add SSE token generation endpoint: POST /v1/auth/sse-token
         - Input: payment_session_id
         - Output: short-lived JWT (15 min expiry)
         - Scope limited to that payment session

      2. Frontend requests SSE token before creating EventSource

      3. Backend validates SSE token:
         - Check expiry (15 min)
         - Check scope (payment_session_id)
         - Single use (optional - track used tokens)

      4. Document security trade-off in docs

      TDD Approach:
      1. Write failing tests for SSE token generation
      2. Implement endpoint
      3. Update frontend to request SSE token
      4. Test end-to-end

      Acceptance Criteria:
      - SSE token endpoint implemented
      - Tokens expire in 15 minutes
      - Tokens scoped to payment session
      - Frontend requests token before SSE
      - Tests prove security improvement
      - Documentation updated
    agent: "security-engineer"
    depends_on: []
    produces:
      - name: "SSE Token Endpoint"
        type: "file"
        path: "products/stablecoin-gateway/apps/api/src/routes/v1/auth.ts"
      - name: "SSE Token Frontend"
        type: "file"
        path: "products/stablecoin-gateway/apps/web/src/lib/api-client.ts"
      - name: "SSE Token Tests"
        type: "file"
        path: "products/stablecoin-gateway/apps/api/tests/integration/sse-token.test.ts"
    parallel_ok: true
    checkpoint: false
    priority: "high"
    estimated_time_minutes: 75
    acceptance_criteria:
      - "POST /v1/auth/sse-token endpoint implemented"
      - "Tokens expire in 15 minutes"
      - "Tokens scoped to payment session ID"
      - "Frontend requests SSE token"
      - "Tests prove token validation"
      - "Documentation updated"
    status: "pending"

  # ============================================================================
  # ISSUE 3: FRONTEND AUTH LIFECYCLE INCOMPLETE (HIGH PRIORITY)
  # ============================================================================

  - id: "PHASE2-03"
    name: "Implement Frontend Auth Lifecycle"
    description: |
      ISSUE #3: Frontend auth lifecycle incomplete

      Root cause:
      - No login flow implementation
      - No calls to /v1/auth/login
      - No token refresh logic
      - TokenManager is storage-only

      Files to modify/create:
      - apps/web/src/lib/api-client.ts (add login, refresh methods)
      - apps/web/src/lib/token-manager.ts (add refresh logic)
      - apps/web/src/pages/Login.tsx (create login UI)
      - apps/web/src/hooks/useAuth.tsx (create auth hook)

      Implementation:
      1. Add login method to API client:
         - POST /v1/auth/login (email, password)
         - Store access token in TokenManager
         - Store refresh token (if backend supports)

      2. Add token refresh logic:
         - Check token expiry before requests
         - Auto-refresh if expired
         - Redirect to login if refresh fails

      3. Create login page (simple MVP):
         - Email + password form
         - Error handling
         - Redirect after login

      4. Create useAuth hook:
         - isAuthenticated
         - login()
         - logout()
         - user info

      TDD Approach:
      1. Write tests for login flow
      2. Write tests for token refresh
      3. Implement API client methods
      4. Implement UI components
      5. All tests pass

      Acceptance Criteria:
      - login() method in API client
      - Token refresh logic implemented
      - Login page created
      - useAuth hook created
      - Tests prove auth lifecycle works
      - User can login and stay authenticated
    agent: "frontend-engineer"
    depends_on: []
    produces:
      - name: "API Client Auth Methods"
        type: "file"
        path: "products/stablecoin-gateway/apps/web/src/lib/api-client.ts"
      - name: "Token Refresh Logic"
        type: "file"
        path: "products/stablecoin-gateway/apps/web/src/lib/token-manager.ts"
      - name: "Login Page"
        type: "file"
        path: "products/stablecoin-gateway/apps/web/src/pages/Login.tsx"
      - name: "Auth Hook"
        type: "file"
        path: "products/stablecoin-gateway/apps/web/src/hooks/useAuth.tsx"
      - name: "Auth Tests"
        type: "file"
        path: "products/stablecoin-gateway/apps/web/tests/lib/auth-lifecycle.test.ts"
    parallel_ok: true
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 90
    acceptance_criteria:
      - "login() method implemented"
      - "Token refresh logic implemented"
      - "Login page created"
      - "useAuth hook created"
      - "15+ tests passing"
      - "User can login and stay authenticated"
    status: "pending"

  # ============================================================================
  # ISSUE 4: PASSWORD POLICY TOO WEAK (MEDIUM PRIORITY)
  # ============================================================================

  - id: "PHASE2-04"
    name: "Strengthen Password Policy"
    description: |
      ISSUE #4: Password policy too weak

      Root cause:
      - Current: 8 chars + 1 uppercase + 1 number
      - Best practice: 12+ chars + uppercase + lowercase + number + special

      File to modify:
      - apps/api/src/utils/validation.ts (lines 21-28)

      New requirements:
      - Minimum 12 characters
      - At least 1 uppercase letter
      - At least 1 lowercase letter
      - At least 1 number
      - At least 1 special character (!@#$%^&*()_+-=[]{}|;:,.<>?)

      TDD Approach:
      1. Write failing tests for new password requirements
      2. Update Zod schema with new rules
      3. Test edge cases (11 chars, no special, etc.)
      4. All tests pass

      Additional considerations:
      - Update error messages to be helpful
      - Update API documentation
      - Update frontend validation (if exists)
      - Consider password strength meter (optional)

      Acceptance Criteria:
      - Password requires 12+ characters
      - Password requires uppercase + lowercase
      - Password requires number
      - Password requires special character
      - Tests prove enforcement (10+ tests)
      - Error messages helpful
      - API docs updated
    agent: "backend-engineer"
    depends_on: []
    produces:
      - name: "Updated Validation"
        type: "file"
        path: "products/stablecoin-gateway/apps/api/src/utils/validation.ts"
      - name: "Password Tests"
        type: "file"
        path: "products/stablecoin-gateway/apps/api/tests/utils/validation-password.test.ts"
    parallel_ok: true
    checkpoint: false
    priority: "high"
    estimated_time_minutes: 45
    acceptance_criteria:
      - "Password requires 12+ characters"
      - "Password requires uppercase + lowercase"
      - "Password requires number"
      - "Password requires special character"
      - "10+ tests passing"
      - "Error messages helpful"
      - "API docs updated"
    status: "pending"

  # ============================================================================
  # PHASE 5: INTEGRATION & QA
  # ============================================================================

  - id: "PHASE2-QA"
    name: "Phase 2 Integration Testing"
    description: |
      Test all 4 fixes together:

      1. Run all unit tests
      2. Run all integration tests
      3. Manual testing:
         - Create webhook via API
         - Test SSE with short-lived token
         - Login via frontend UI
         - Test password requirements

      Create test report documenting:
      - All tests passing
      - Manual test scenarios
      - Any issues found

      Fix any test failures from Phase 1 (52 failing tests)

      Acceptance Criteria:
      - All new tests pass
      - Phase 1 test failures fixed
      - Manual testing complete
      - Test report created
    agent: "qa-engineer"
    depends_on: ["PHASE2-01", "PHASE2-02", "PHASE2-03", "PHASE2-04"]
    produces:
      - name: "Phase 2 Test Report"
        type: "document"
        path: "products/stablecoin-gateway/docs/SECURITY-AUDIT-PHASE2-TEST-REPORT.md"
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 60
    acceptance_criteria:
      - "All new tests pass"
      - "Phase 1 test failures addressed"
      - "Manual testing complete"
      - "Test report created"
    status: "pending"

  # ============================================================================
  # PHASE 6: DOCUMENTATION
  # ============================================================================

  - id: "PHASE2-DOC"
    name: "Update Documentation for Phase 2"
    description: |
      Update documentation for all 4 fixes:

      1. API.md - Add webhook endpoints, SSE token endpoint
      2. SECURITY.md - Update SSE auth section, password policy
      3. README.md - Update quick start with login flow
      4. New guide: webhook-setup-guide.md

      Ensure all examples work and are clear.
    agent: "technical-writer"
    depends_on: ["PHASE2-QA"]
    produces:
      - name: "Updated Documentation"
        type: "directory"
        path: "products/stablecoin-gateway/docs/"
    parallel_ok: false
    checkpoint: false
    priority: "high"
    estimated_time_minutes: 45
    acceptance_criteria:
      - "All docs updated"
      - "Webhook guide created"
      - "Examples tested"
      - "Clear for developers"
    status: "pending"

  # ============================================================================
  # PHASE 7: PR & CHECKPOINT
  # ============================================================================

  - id: "PHASE2-PR"
    name: "Create Phase 2 Pull Request"
    description: |
      Create PR for Phase 2 fixes:

      Branch: fix/stablecoin-gateway/security-audit-phase2
      Target: main

      PR Description:
      - Summary of 4 additional issues fixed
      - Test results
      - Documentation updates
      - Link to Phase 1 PR

      Ensure all tests pass before creating PR.
    agent: "security-engineer"
    depends_on: ["PHASE2-DOC"]
    produces:
      - name: "Phase 2 Pull Request"
        type: "pr"
        path: "#{PR_NUMBER}"
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 20
    acceptance_criteria:
      - "PR created"
      - "All tests passing"
      - "Description comprehensive"
    status: "pending"

  - id: "PHASE2-CHECKPOINT"
    name: "Phase 2 Ready for Review"
    description: |
      All 4 additional security issues fixed:

      ✅ Webhook CRUD endpoints
      ✅ SSE auth security improved
      ✅ Frontend auth lifecycle complete
      ✅ Password policy strengthened

      Ready for CEO review and approval.
    agent: "orchestrator"
    depends_on: ["PHASE2-PR"]
    parallel_ok: false
    checkpoint: true
    priority: "critical"
    estimated_time_minutes: 0
    status: "pending"

# Execution estimates:
# - PHASE2-01 (Webhooks): 90 min
# - PHASE2-02 (SSE Security): 75 min (parallel)
# - PHASE2-03 (Auth Lifecycle): 90 min (parallel)
# - PHASE2-04 (Password): 45 min (parallel)
# - PHASE2-QA: 60 min
# - PHASE2-DOC: 45 min
# - PHASE2-PR: 20 min
# - Total: ~6 hours (with parallelization: ~4 hours)
