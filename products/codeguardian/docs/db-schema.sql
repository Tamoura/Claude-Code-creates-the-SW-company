-- ═══════════════════════════════════════════════════════════════════════
-- CodeGuardian Database Schema
-- ═══════════════════════════════════════════════════════════════════════
--
-- Database: codeguardian_dev (PostgreSQL 15+)
-- This SQL schema will be converted to Prisma schema during implementation.
--
-- Conventions:
--   - snake_case for all tables, columns, and constraints
--   - UUID primary keys (generated by application, not database)
--   - created_at / updated_at timestamps on mutable tables
--   - Indexes on all foreign keys and common query patterns
--   - Soft deletes where applicable (deleted_at column)
--
-- ═══════════════════════════════════════════════════════════════════════

-- ─── Extensions ──────────────────────────────────────────────────────

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ─── Enums ───────────────────────────────────────────────────────────

CREATE TYPE org_role AS ENUM ('owner', 'admin', 'member');

CREATE TYPE account_type AS ENUM ('user', 'organization');

CREATE TYPE subscription_plan AS ENUM ('free', 'pro', 'enterprise');

CREATE TYPE subscription_status AS ENUM ('active', 'past_due', 'canceled', 'suspended');

CREATE TYPE review_status AS ENUM ('pending', 'queued', 'analyzing', 'complete', 'failed');

CREATE TYPE finding_category AS ENUM ('security', 'logic', 'performance', 'style');

CREATE TYPE finding_severity AS ENUM ('critical', 'high', 'medium', 'low', 'info');

CREATE TYPE dismiss_reason AS ENUM ('false_positive', 'wont_fix', 'not_applicable', 'already_fixed');

CREATE TYPE billing_event_type AS ENUM ('checkout', 'payment', 'invoice', 'cancellation', 'refund');

CREATE TYPE webhook_source AS ENUM ('github', 'stripe');

CREATE TYPE digest_frequency AS ENUM ('daily', 'weekly', 'never');

-- ─── Users ───────────────────────────────────────────────────────────

CREATE TABLE users (
    id              UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
    github_id       TEXT        NOT NULL UNIQUE,
    github_login    TEXT        NOT NULL,
    email           TEXT,
    avatar_url      TEXT,
    -- GitHub tokens encrypted at rest (AES-256-GCM)
    access_token_encrypted  TEXT,
    refresh_token_encrypted TEXT,
    token_expires_at        TIMESTAMPTZ,
    -- Notification preferences
    notify_on_review_complete   BOOLEAN     NOT NULL DEFAULT true,
    notify_on_critical_finding  BOOLEAN     NOT NULL DEFAULT true,
    notify_on_limit_reached     BOOLEAN     NOT NULL DEFAULT true,
    email_digest_frequency      digest_frequency NOT NULL DEFAULT 'weekly',
    -- Timestamps
    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_users_github_id ON users(github_id);
CREATE INDEX idx_users_email ON users(email) WHERE email IS NOT NULL;

COMMENT ON TABLE users IS 'Users authenticated via GitHub OAuth. Tokens stored encrypted.';
COMMENT ON COLUMN users.access_token_encrypted IS 'AES-256-GCM encrypted GitHub access token';
COMMENT ON COLUMN users.refresh_token_encrypted IS 'AES-256-GCM encrypted GitHub refresh token';

-- ─── Organizations ───────────────────────────────────────────────────

CREATE TABLE organizations (
    id              UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
    github_org_id   TEXT        NOT NULL UNIQUE,
    name            TEXT        NOT NULL,
    avatar_url      TEXT,
    -- Default settings for all repos in this org
    default_routing_config  JSONB,
    default_score_threshold INTEGER     NOT NULL DEFAULT 70,
    default_block_on_critical BOOLEAN   NOT NULL DEFAULT true,
    -- Timestamps
    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_organizations_github_org_id ON organizations(github_org_id);

COMMENT ON TABLE organizations IS 'GitHub organizations. Settings apply as defaults to all repos.';

-- ─── Organization Memberships ────────────────────────────────────────

CREATE TABLE org_memberships (
    id              UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id         UUID        NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    org_id          UUID        NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    role            org_role    NOT NULL DEFAULT 'member',
    joined_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    UNIQUE(user_id, org_id)
);

CREATE INDEX idx_org_memberships_user_id ON org_memberships(user_id);
CREATE INDEX idx_org_memberships_org_id ON org_memberships(org_id);

COMMENT ON TABLE org_memberships IS 'Maps users to organizations with role-based access.';

-- ─── Installations (GitHub App) ──────────────────────────────────────

CREATE TABLE installations (
    id                      UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
    github_installation_id  TEXT        NOT NULL UNIQUE,
    -- An installation belongs to either a user or an org (not both)
    user_id                 UUID        REFERENCES users(id) ON DELETE SET NULL,
    org_id                  UUID        REFERENCES organizations(id) ON DELETE SET NULL,
    account_type            account_type NOT NULL,
    -- Permissions granted by the user during installation
    permissions             JSONB       NOT NULL DEFAULT '{}',
    -- Lifecycle
    created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    suspended_at            TIMESTAMPTZ,

    -- Exactly one of user_id or org_id must be set
    CONSTRAINT chk_installation_owner CHECK (
        (user_id IS NOT NULL AND org_id IS NULL) OR
        (user_id IS NULL AND org_id IS NOT NULL)
    )
);

CREATE INDEX idx_installations_github_id ON installations(github_installation_id);
CREATE INDEX idx_installations_user_id ON installations(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_installations_org_id ON installations(org_id) WHERE org_id IS NOT NULL;

COMMENT ON TABLE installations IS 'GitHub App installations. One per user account or organization.';

-- ─── Repositories ────────────────────────────────────────────────────

CREATE TABLE repositories (
    id                  UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
    github_repo_id      TEXT        NOT NULL UNIQUE,
    installation_id     UUID        NOT NULL REFERENCES installations(id) ON DELETE CASCADE,
    -- Owner: either an org or a personal user
    org_id              UUID        REFERENCES organizations(id) ON DELETE SET NULL,
    owner_id            UUID        NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    full_name           TEXT        NOT NULL,         -- "owner/repo"
    default_branch      TEXT        NOT NULL DEFAULT 'main',
    -- Monitoring config
    monitoring_enabled  BOOLEAN     NOT NULL DEFAULT true,
    -- Per-repo routing config override (null = use org/system defaults)
    routing_config      JSONB,
    score_threshold     INTEGER     NOT NULL DEFAULT 70,
    block_on_critical   BOOLEAN     NOT NULL DEFAULT true,
    -- Timestamps
    created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_repositories_github_repo_id ON repositories(github_repo_id);
CREATE INDEX idx_repositories_installation_id ON repositories(installation_id);
CREATE INDEX idx_repositories_org_id ON repositories(org_id) WHERE org_id IS NOT NULL;
CREATE INDEX idx_repositories_owner_id ON repositories(owner_id);
CREATE INDEX idx_repositories_full_name ON repositories(full_name);
CREATE INDEX idx_repositories_monitoring ON repositories(monitoring_enabled) WHERE monitoring_enabled = true;

COMMENT ON TABLE repositories IS 'Repositories monitored by CodeGuardian via GitHub App.';
COMMENT ON COLUMN repositories.routing_config IS 'JSON override for model routing. Null = use org/system defaults.';

-- ─── Reviews ─────────────────────────────────────────────────────────

CREATE TABLE reviews (
    id                  UUID            PRIMARY KEY DEFAULT uuid_generate_v4(),
    repository_id       UUID            NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
    triggered_by        UUID            REFERENCES users(id) ON DELETE SET NULL,
    -- PR metadata
    pr_number           INTEGER         NOT NULL,
    pr_title            TEXT            NOT NULL,
    head_sha            TEXT            NOT NULL,
    base_branch         TEXT            NOT NULL,
    head_branch         TEXT            NOT NULL,
    lines_changed       INTEGER         NOT NULL DEFAULT 0,
    files_changed       INTEGER         NOT NULL DEFAULT 0,
    -- Review status and results
    status              review_status   NOT NULL DEFAULT 'pending',
    score               INTEGER         CHECK (score >= 0 AND score <= 100),
    score_security      INTEGER         CHECK (score_security >= 0 AND score_security <= 100),
    score_logic         INTEGER         CHECK (score_logic >= 0 AND score_logic <= 100),
    score_performance   INTEGER         CHECK (score_performance >= 0 AND score_performance <= 100),
    score_style         INTEGER         CHECK (score_style >= 0 AND score_style <= 100),
    findings_count      INTEGER         NOT NULL DEFAULT 0,
    -- Processing metadata
    chunks_processed    INTEGER         NOT NULL DEFAULT 0,
    models_used         TEXT[]          NOT NULL DEFAULT '{}',
    duration_ms         INTEGER,
    error_message       TEXT,
    -- GitHub interaction
    github_review_id    BIGINT,         -- GitHub review ID after posting
    -- Timestamps
    created_at          TIMESTAMPTZ     NOT NULL DEFAULT NOW(),
    completed_at        TIMESTAMPTZ
);

CREATE INDEX idx_reviews_repository_id ON reviews(repository_id);
CREATE INDEX idx_reviews_triggered_by ON reviews(triggered_by) WHERE triggered_by IS NOT NULL;
CREATE INDEX idx_reviews_status ON reviews(status);
CREATE INDEX idx_reviews_created_at ON reviews(created_at DESC);
CREATE INDEX idx_reviews_score ON reviews(score) WHERE score IS NOT NULL;

-- Composite indexes for common dashboard queries
CREATE INDEX idx_reviews_repo_status_created ON reviews(repository_id, status, created_at DESC);
CREATE INDEX idx_reviews_repo_created ON reviews(repository_id, created_at DESC);
CREATE INDEX idx_reviews_user_created ON reviews(triggered_by, created_at DESC) WHERE triggered_by IS NOT NULL;

-- For PR-level lookups (check if PR already has a pending/analyzing review)
CREATE INDEX idx_reviews_repo_pr_status ON reviews(repository_id, pr_number, status);

COMMENT ON TABLE reviews IS 'One review per PR event (opened/synchronized). Contains aggregate results.';
COMMENT ON COLUMN reviews.score IS 'Composite quality score 0-100. Null while review is in progress.';
COMMENT ON COLUMN reviews.github_review_id IS 'GitHub review ID returned after posting comments.';

-- ─── Findings ────────────────────────────────────────────────────────

CREATE TABLE findings (
    id                  UUID                PRIMARY KEY DEFAULT uuid_generate_v4(),
    review_id           UUID                NOT NULL REFERENCES reviews(id) ON DELETE CASCADE,
    -- Classification
    category            finding_category    NOT NULL,
    severity            finding_severity    NOT NULL,
    title               TEXT                NOT NULL,
    description         TEXT                NOT NULL,
    suggestion          TEXT,               -- Suggested code fix (nullable)
    -- Location in the diff
    file_path           TEXT                NOT NULL,
    line_start          INTEGER             NOT NULL,
    line_end            INTEGER,
    -- Security-specific metadata
    owasp_id            TEXT,               -- e.g., "A03:2021"
    cwe_id              TEXT,               -- e.g., "CWE-89"
    -- Model attribution
    model_used          TEXT                NOT NULL,
    -- User feedback
    dismissed           BOOLEAN             NOT NULL DEFAULT false,
    dismissed_reason    dismiss_reason,
    dismissed_by        UUID                REFERENCES users(id) ON DELETE SET NULL,
    dismissed_at        TIMESTAMPTZ,
    -- GitHub interaction
    github_comment_id   BIGINT,            -- GitHub comment ID after posting
    -- Timestamp
    created_at          TIMESTAMPTZ         NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_findings_review_id ON findings(review_id);
CREATE INDEX idx_findings_category ON findings(category);
CREATE INDEX idx_findings_severity ON findings(severity);
CREATE INDEX idx_findings_dismissed ON findings(dismissed);

-- Composite indexes for analytics queries
CREATE INDEX idx_findings_review_category ON findings(review_id, category);
CREATE INDEX idx_findings_review_severity ON findings(review_id, severity);
CREATE INDEX idx_findings_category_title ON findings(category, title);

-- For deduplication during aggregation
CREATE INDEX idx_findings_review_file_line ON findings(review_id, file_path, line_start);

COMMENT ON TABLE findings IS 'Individual issues found during review. One finding per issue per file location.';
COMMENT ON COLUMN findings.suggestion IS 'Suggested code fix. Posted as GitHub suggestion syntax.';
COMMENT ON COLUMN findings.owasp_id IS 'OWASP Top 10 (2021) category, e.g., A03:2021 Injection.';
COMMENT ON COLUMN findings.cwe_id IS 'Common Weakness Enumeration ID, e.g., CWE-89.';

-- ─── Subscriptions ───────────────────────────────────────────────────

CREATE TABLE subscriptions (
    id                      UUID                PRIMARY KEY DEFAULT uuid_generate_v4(),
    -- Owner: either an org or a personal user (not both)
    org_id                  UUID                REFERENCES organizations(id) ON DELETE CASCADE,
    user_id                 UUID                REFERENCES users(id) ON DELETE CASCADE,
    -- Stripe integration
    stripe_customer_id      TEXT,
    stripe_subscription_id  TEXT                UNIQUE,
    -- Plan details
    plan                    subscription_plan   NOT NULL DEFAULT 'free',
    status                  subscription_status NOT NULL DEFAULT 'active',
    seat_count              INTEGER             NOT NULL DEFAULT 1,
    -- Usage tracking
    pr_limit                INTEGER,            -- null = unlimited
    prs_used_this_month     INTEGER             NOT NULL DEFAULT 0,
    -- Billing period
    current_period_start    TIMESTAMPTZ         NOT NULL DEFAULT NOW(),
    current_period_end      TIMESTAMPTZ         NOT NULL DEFAULT (NOW() + INTERVAL '30 days'),
    -- Timestamps
    created_at              TIMESTAMPTZ         NOT NULL DEFAULT NOW(),
    updated_at              TIMESTAMPTZ         NOT NULL DEFAULT NOW(),

    -- Exactly one of user_id or org_id must be set
    CONSTRAINT chk_subscription_owner CHECK (
        (user_id IS NOT NULL AND org_id IS NULL) OR
        (user_id IS NULL AND org_id IS NOT NULL)
    )
);

CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_subscriptions_org_id ON subscriptions(org_id) WHERE org_id IS NOT NULL;
CREATE INDEX idx_subscriptions_stripe_customer ON subscriptions(stripe_customer_id) WHERE stripe_customer_id IS NOT NULL;
CREATE INDEX idx_subscriptions_stripe_sub ON subscriptions(stripe_subscription_id) WHERE stripe_subscription_id IS NOT NULL;
CREATE INDEX idx_subscriptions_status ON subscriptions(status);

COMMENT ON TABLE subscriptions IS 'Billing subscriptions. One per user or org. Free tier created on signup.';
COMMENT ON COLUMN subscriptions.pr_limit IS 'Monthly PR review limit. Null means unlimited (Pro/Enterprise).';

-- ─── Billing Events ──────────────────────────────────────────────────

CREATE TABLE billing_events (
    id                  UUID                PRIMARY KEY DEFAULT uuid_generate_v4(),
    subscription_id     UUID                NOT NULL REFERENCES subscriptions(id) ON DELETE CASCADE,
    -- Stripe event tracking
    stripe_event_id     TEXT                UNIQUE,
    event_type          billing_event_type  NOT NULL,
    -- Financial data
    amount_cents        INTEGER             NOT NULL DEFAULT 0,
    currency            TEXT                NOT NULL DEFAULT 'usd',
    -- Additional metadata
    metadata            JSONB               NOT NULL DEFAULT '{}',
    -- Timestamp
    created_at          TIMESTAMPTZ         NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_billing_events_subscription_id ON billing_events(subscription_id);
CREATE INDEX idx_billing_events_stripe_event ON billing_events(stripe_event_id) WHERE stripe_event_id IS NOT NULL;
CREATE INDEX idx_billing_events_type ON billing_events(event_type);
CREATE INDEX idx_billing_events_created_at ON billing_events(created_at DESC);

COMMENT ON TABLE billing_events IS 'Immutable log of all billing events from Stripe. Used for audit and debugging.';

-- ─── Webhook Logs ────────────────────────────────────────────────────

CREATE TABLE webhook_logs (
    id              UUID            PRIMARY KEY DEFAULT uuid_generate_v4(),
    source          webhook_source  NOT NULL,
    event_type      TEXT            NOT NULL,
    delivery_id     TEXT            UNIQUE,         -- GitHub: X-GitHub-Delivery, Stripe: event ID
    -- Processing result
    status_code     INTEGER         NOT NULL,
    error_message   TEXT,
    -- Payload (for debugging; consider TTL/purge policy)
    payload         JSONB           NOT NULL DEFAULT '{}',
    -- Timestamps
    received_at     TIMESTAMPTZ     NOT NULL DEFAULT NOW(),
    processed_at    TIMESTAMPTZ
);

CREATE INDEX idx_webhook_logs_source ON webhook_logs(source);
CREATE INDEX idx_webhook_logs_event_type ON webhook_logs(event_type);
CREATE INDEX idx_webhook_logs_delivery_id ON webhook_logs(delivery_id) WHERE delivery_id IS NOT NULL;
CREATE INDEX idx_webhook_logs_received_at ON webhook_logs(received_at DESC);
CREATE INDEX idx_webhook_logs_status ON webhook_logs(status_code);

-- Composite for debugging: find failed webhooks of a specific type
CREATE INDEX idx_webhook_logs_source_type_status ON webhook_logs(source, event_type, status_code);

COMMENT ON TABLE webhook_logs IS 'Log of all incoming webhooks for debugging and audit. Consider data retention policy.';

-- ─── Audit Logs ──────────────────────────────────────────────────────
-- Generic audit log for security-relevant actions.
-- Uses the pattern from @connectsw/audit package.

CREATE TABLE audit_logs (
    id              UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
    actor           TEXT        NOT NULL,          -- user ID or "system"
    action          TEXT        NOT NULL,          -- e.g., "settings.update", "review.retry"
    resource_type   TEXT        NOT NULL,          -- e.g., "repository", "subscription"
    resource_id     TEXT        NOT NULL,
    details         JSONB,
    ip              TEXT,
    user_agent      TEXT,
    timestamp       TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_actor ON audit_logs(actor);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource_type ON audit_logs(resource_type);
CREATE INDEX idx_audit_logs_timestamp ON audit_logs(timestamp DESC);

-- Composite for querying audit trail of a specific resource
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id, timestamp DESC);

COMMENT ON TABLE audit_logs IS 'Immutable audit trail for security-relevant actions. Enterprise feature.';

-- ─── OAuth States (temporary) ────────────────────────────────────────
-- Short-lived records for OAuth CSRF protection and PKCE.

CREATE TABLE oauth_states (
    id              UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
    state           TEXT        NOT NULL UNIQUE,
    pkce_verifier   TEXT        NOT NULL,
    redirect_url    TEXT,
    expires_at      TIMESTAMPTZ NOT NULL,
    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_oauth_states_state ON oauth_states(state);
CREATE INDEX idx_oauth_states_expires ON oauth_states(expires_at);

COMMENT ON TABLE oauth_states IS 'Temporary OAuth state storage for CSRF + PKCE. Records expire after 10 minutes.';

-- ═══════════════════════════════════════════════════════════════════════
-- Functions and Triggers
-- ═══════════════════════════════════════════════════════════════════════

-- Auto-update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply to all mutable tables
CREATE TRIGGER trg_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_organizations_updated_at
    BEFORE UPDATE ON organizations
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_repositories_updated_at
    BEFORE UPDATE ON repositories
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_subscriptions_updated_at
    BEFORE UPDATE ON subscriptions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ═══════════════════════════════════════════════════════════════════════
-- Data Retention Cleanup (to be run by scheduled job)
-- ═══════════════════════════════════════════════════════════════════════

-- Cleanup expired OAuth states (run every 5 minutes)
-- DELETE FROM oauth_states WHERE expires_at < NOW();

-- Cleanup old webhook logs based on retention policy (run nightly)
-- Free tier: 30 days
-- Pro tier: 1 year
-- Enterprise: unlimited
-- Example for Free tier cleanup:
-- DELETE FROM webhook_logs
-- WHERE received_at < NOW() - INTERVAL '30 days'
-- AND id IN (
--     SELECT wl.id FROM webhook_logs wl
--     JOIN repositories r ON ... -- join to determine tier
--     WHERE subscription.plan = 'free'
-- );

-- ═══════════════════════════════════════════════════════════════════════
-- Seed Data (Development Only)
-- ═══════════════════════════════════════════════════════════════════════

-- Default routing configuration (stored as reference, used in application code)
-- {
--   "security": {
--     "primaryModel": "claude-sonnet",
--     "fallbackModel": "gpt-4o",
--     "timeoutSeconds": 30
--   },
--   "logic": {
--     "primaryModel": "claude-opus",
--     "fallbackModel": "claude-sonnet",
--     "timeoutSeconds": 45
--   },
--   "performance": {
--     "primaryModel": "gpt-4o",
--     "fallbackModel": "claude-sonnet",
--     "timeoutSeconds": 30
--   },
--   "style": {
--     "primaryModel": "claude-haiku",
--     "fallbackModel": "gpt-4o-mini",
--     "timeoutSeconds": 15
--   }
-- }
