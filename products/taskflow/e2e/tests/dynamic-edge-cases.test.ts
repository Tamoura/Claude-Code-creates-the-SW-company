/**
 * Dynamic Test Generation — Edge Cases
 *
 * Generated by QA Engineer using Dynamic Test Generation protocol
 * Source: Code analysis of TaskFlow MVP implementation
 * Categories: Boundary values, state transitions, rapid interactions
 */
import { test, expect } from '@playwright/test';

test.describe('Dynamic Tests: Boundary Values', () => {
  test.beforeEach(async ({ page }) => {
    const email = `dynamic-${Date.now()}@test.com`;
    await page.goto('/login');
    await page.getByRole('tab', { name: /register/i }).click();
    await page.getByLabel(/email/i).fill(email);
    await page.getByLabel(/password/i).fill('TestPassword123!');
    await page.getByRole('button', { name: /register|sign up|create/i }).click();
    await expect(page).toHaveURL(/dashboard/, { timeout: 5000 });
  });

  test('boundary: rejects empty task title', async ({ page }) => {
    // Try to submit with empty title
    await page.getByRole('button', { name: /add/i }).click();
    // Should not create a task — task list should remain empty
    await page.waitForTimeout(500);
    const tasks = await page.locator('[data-testid="task-item"]').count();
    expect(tasks).toBe(0);
  });

  test('boundary: handles max length title (200 chars)', async ({ page }) => {
    const longTitle = 'A'.repeat(200);
    await page.getByPlaceholder(/task/i).fill(longTitle);
    await page.getByRole('button', { name: /add/i }).click();
    // Should succeed — 200 chars is the limit
    await page.waitForTimeout(1000);
  });

  test('boundary: rejects over-length title (201 chars)', async ({ page }) => {
    const tooLongTitle = 'A'.repeat(201);
    await page.getByPlaceholder(/task/i).fill(tooLongTitle);
    await page.getByRole('button', { name: /add/i }).click();
    // Should show error or not create task
    await page.waitForTimeout(1000);
  });
});

test.describe('Dynamic Tests: State Transitions', () => {
  test.beforeEach(async ({ page }) => {
    const email = `state-${Date.now()}@test.com`;
    await page.goto('/login');
    await page.getByRole('tab', { name: /register/i }).click();
    await page.getByLabel(/email/i).fill(email);
    await page.getByLabel(/password/i).fill('TestPassword123!');
    await page.getByRole('button', { name: /register|sign up|create/i }).click();
    await expect(page).toHaveURL(/dashboard/, { timeout: 5000 });
  });

  test('state: complete then uncomplete a task', async ({ page }) => {
    // Create task
    await page.getByPlaceholder(/task/i).fill('Toggle Test');
    await page.getByRole('button', { name: /add/i }).click();
    await page.waitForTimeout(500);

    // Complete
    await page.getByRole('checkbox').first().click();
    await page.waitForTimeout(500);

    // Uncomplete
    await page.getByRole('checkbox').first().click();
    await page.waitForTimeout(500);
    // Task should be back to active state
  });

  test('state: create, delete all, verify empty state', async ({ page }) => {
    // Create a task
    await page.getByPlaceholder(/task/i).fill('Temp Task');
    await page.getByRole('button', { name: /add/i }).click();
    await page.waitForTimeout(500);

    // Delete it
    await page.getByRole('button', { name: /delete/i }).first().click();
    await page.waitForTimeout(500);

    // Should show empty state
    await expect(page.getByText(/no tasks/i)).toBeVisible({ timeout: 3000 });
  });
});

test.describe('Dynamic Tests: Rapid Interactions', () => {
  test.beforeEach(async ({ page }) => {
    const email = `rapid-${Date.now()}@test.com`;
    await page.goto('/login');
    await page.getByRole('tab', { name: /register/i }).click();
    await page.getByLabel(/email/i).fill(email);
    await page.getByLabel(/password/i).fill('TestPassword123!');
    await page.getByRole('button', { name: /register|sign up|create/i }).click();
    await expect(page).toHaveURL(/dashboard/, { timeout: 5000 });
  });

  test('rapid: double-click add does not create duplicate', async ({ page }) => {
    const taskTitle = `Rapid ${Date.now()}`;
    await page.getByPlaceholder(/task/i).fill(taskTitle);
    // Double-click the add button
    await page.getByRole('button', { name: /add/i }).dblclick();
    await page.waitForTimeout(1000);

    // Count tasks with this title — should be 0 or 1, not 2
    const count = await page.getByText(taskTitle).count();
    expect(count).toBeLessThanOrEqual(1);
  });

  test('rapid: create multiple tasks quickly', async ({ page }) => {
    for (let i = 1; i <= 3; i++) {
      await page.getByPlaceholder(/task/i).fill(`Quick Task ${i}`);
      await page.getByRole('button', { name: /add/i }).click();
      await page.waitForTimeout(300);
    }

    // All 3 should exist
    await page.waitForTimeout(1000);
    await expect(page.getByText('Quick Task 1')).toBeVisible();
    await expect(page.getByText('Quick Task 2')).toBeVisible();
    await expect(page.getByText('Quick Task 3')).toBeVisible();
  });
});

test.describe('Dynamic Tests: Auth Edge Cases', () => {
  test('auth: register with invalid email format', async ({ page }) => {
    await page.goto('/login');
    await page.getByRole('tab', { name: /register/i }).click();
    await page.getByLabel(/email/i).fill('not-an-email');
    await page.getByLabel(/password/i).fill('TestPassword123!');
    await page.getByRole('button', { name: /register|sign up|create/i }).click();

    // Should show error, NOT redirect to dashboard
    await page.waitForTimeout(1000);
    await expect(page).toHaveURL(/login/);
  });

  test('auth: register with short password', async ({ page }) => {
    await page.goto('/login');
    await page.getByRole('tab', { name: /register/i }).click();
    await page.getByLabel(/email/i).fill(`short-${Date.now()}@test.com`);
    await page.getByLabel(/password/i).fill('123');
    await page.getByRole('button', { name: /register|sign up|create/i }).click();

    // Should show error, NOT redirect
    await page.waitForTimeout(1000);
    await expect(page).toHaveURL(/login/);
  });

  test('auth: sign out clears session', async ({ page }) => {
    // Register and login
    const email = `signout-${Date.now()}@test.com`;
    await page.goto('/login');
    await page.getByRole('tab', { name: /register/i }).click();
    await page.getByLabel(/email/i).fill(email);
    await page.getByLabel(/password/i).fill('TestPassword123!');
    await page.getByRole('button', { name: /register|sign up|create/i }).click();
    await expect(page).toHaveURL(/dashboard/, { timeout: 5000 });

    // Sign out
    await page.getByRole('button', { name: /sign out|logout/i }).click();

    // Should redirect to login
    await expect(page).toHaveURL(/login/, { timeout: 3000 });

    // Navigating to dashboard should redirect back to login
    await page.goto('/dashboard');
    await expect(page).toHaveURL(/login/, { timeout: 3000 });
  });
});
