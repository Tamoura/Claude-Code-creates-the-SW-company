// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  ADMIN
  MANAGER
  ANALYST
  VIEWER
}

enum RiskStatus {
  IDENTIFIED
  ASSESSED
  MITIGATING
  ACCEPTED
  CLOSED
}

enum ControlStatus {
  NOT_IMPLEMENTED
  PARTIALLY_IMPLEMENTED
  IMPLEMENTED
  NOT_APPLICABLE
}

enum AssetType {
  HARDWARE
  SOFTWARE
  DATA
  NETWORK
  PERSONNEL
  FACILITY
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  DECOMMISSIONED
}

enum Criticality {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum FrameworkType {
  NIST_CSF
  ISO_27001
  COBIT
  IT4IT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  READ
  EXPORT
}

// ==================== ORGANIZATION ====================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  settings  Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users       User[]
  risks       Risk[]
  controls    Control[]
  assets      Asset[]
  assessments Assessment[]
  auditLogs   AuditLog[]

  @@map("organizations")
}

// ==================== USER & AUTH ====================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         Role     @default(VIEWER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations
  sessions            Session[]
  ownedRisks          Risk[]       @relation("RiskOwner")
  ownedControls       Control[]    @relation("ControlOwner")
  ownedAssets         Asset[]      @relation("AssetOwner")
  assessments         Assessment[] @relation("Assessor")
  approvedAssessments Assessment[] @relation("Approver")
  auditLogs           AuditLog[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// ==================== RISK ====================

model Risk {
  id             String     @id @default(uuid())
  title          String
  description    String
  category       String
  likelihood     Int        @db.SmallInt // 1-5
  impact         Int        @db.SmallInt // 1-5
  status         RiskStatus @default(IDENTIFIED)
  mitigationPlan String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Owner
  ownerId String?
  owner   User?   @relation("RiskOwner", fields: [ownerId], references: [id])

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations (many-to-many)
  controls RiskControl[]
  assets   RiskAsset[]

  @@index([organizationId])
  @@index([status])
  @@index([category])
  @@map("risks")
}

model RiskControl {
  riskId    String
  controlId String
  createdAt DateTime @default(now())

  risk    Risk    @relation(fields: [riskId], references: [id], onDelete: Cascade)
  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@id([riskId, controlId])
  @@map("risk_controls")
}

model RiskAsset {
  riskId    String
  assetId   String
  createdAt DateTime @default(now())

  risk  Risk  @relation(fields: [riskId], references: [id], onDelete: Cascade)
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@id([riskId, assetId])
  @@map("risk_assets")
}

// ==================== CONTROL ====================

model Control {
  id                  String        @id @default(uuid())
  code                String        @unique
  title               String
  description         String
  category            String
  status              ControlStatus @default(NOT_IMPLEMENTED)
  implementationNotes String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Owner
  ownerId String?
  owner   User?   @relation("ControlOwner", fields: [ownerId], references: [id])

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations
  risks             RiskControl[]
  frameworkMappings ControlFrameworkMapping[]
  assessments       Assessment[]

  @@index([organizationId])
  @@index([code])
  @@index([status])
  @@index([category])
  @@map("controls")
}

model ControlFrameworkMapping {
  id          String   @id @default(uuid())
  referenceId String // Framework-specific ID (e.g., "PR.AC-1", "A.5.1.1")
  createdAt   DateTime @default(now())

  // Relations
  controlId   String
  control     Control   @relation(fields: [controlId], references: [id], onDelete: Cascade)
  frameworkId String
  framework   Framework @relation(fields: [frameworkId], references: [id])

  @@unique([controlId, frameworkId, referenceId])
  @@index([frameworkId])
  @@map("control_framework_mappings")
}

// ==================== ASSET ====================

model Asset {
  id          String      @id @default(uuid())
  name        String
  description String?
  type        AssetType
  status      AssetStatus @default(ACTIVE)
  criticality Criticality
  location    String?
  metadata    Json?       @default("{}")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Owner
  ownerId String?
  owner   User?   @relation("AssetOwner", fields: [ownerId], references: [id])

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations
  risks RiskAsset[]

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([criticality])
  @@index([name])
  @@map("assets")
}

// ==================== ASSESSMENT ====================

model Assessment {
  id                  String           @id @default(uuid())
  status              AssessmentStatus @default(DRAFT)
  effectivenessRating Int              @db.SmallInt // 1-5
  findings            String
  recommendations     String?
  evidence            Json?            @default("[]") // Array of file URLs
  assessmentDate      DateTime         @db.Date
  nextReviewDate      DateTime?        @db.Date
  approvalDate        DateTime?
  approvalComments    String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Control being assessed
  controlId String
  control   Control @relation(fields: [controlId], references: [id])

  // Assessor (who performed the assessment)
  assessorId String
  assessor   User   @relation("Assessor", fields: [assessorId], references: [id])

  // Approver (manager who approved/rejected)
  approverId String?
  approver   User?   @relation("Approver", fields: [approverId], references: [id])

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([controlId])
  @@index([status])
  @@index([assessmentDate])
  @@map("assessments")
}

// ==================== FRAMEWORK ====================

model Framework {
  id            String        @id @default(uuid())
  name          String
  version       String
  type          FrameworkType
  description   String?
  publishedDate DateTime?     @db.Date
  data          Json // Categories, subcategories, requirements
  createdAt     DateTime      @default(now())

  // Relations
  controlMappings ControlFrameworkMapping[]

  @@unique([type, version])
  @@map("frameworks")
}

// ==================== AUDIT LOG ====================
// Note: In production, this table should be partitioned by timestamp
// for efficient 7-year retention queries

model AuditLog {
  id         String      @id @default(uuid())
  timestamp  DateTime    @default(now())
  action     AuditAction
  entityType String
  entityId   String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  metadata   Json?       @default("{}")

  // User who performed the action (nullable for system events)
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Organization
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, timestamp])
  @@index([userId, timestamp])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}
