#!/bin/bash
#
# Pre-commit safety hook
# 1. Prevents accidental mass file commits (30 files / 5000 deletions threshold)
# 2. Scans staged files for secrets (gitleaks)
# 3. Validates staged GitHub Actions workflows (actionlint)
#

MAX_FILES=30
MAX_DELETIONS=5000

# Count staged files
staged_count=$(git diff --cached --name-only | wc -l | tr -d ' ')

# Count total deleted lines in staged changes
deleted_lines=$(git diff --cached --numstat | awk '{ sum += $2 } END { print sum+0 }')

if [ "$staged_count" -gt "$MAX_FILES" ] && [ "${ALLOW_LARGE_COMMIT:-0}" != "1" ]; then
  echo ""
  echo "ERROR: $staged_count files staged (threshold: $MAX_FILES)."
  echo ""
  echo "This looks like an accidental mass commit. Common causes:"
  echo "  - Branch created from wrong parent (e.g. wrong base branch)"
  echo "  - Used 'git add .' instead of adding specific files"
  echo ""
  echo "To verify what's staged:  git diff --cached --stat"
  echo "To proceed anyway:        ALLOW_LARGE_COMMIT=1 git commit ..."
  echo ""
  exit 1
fi

if [ "$deleted_lines" -gt "$MAX_DELETIONS" ] && [ "${ALLOW_LARGE_COMMIT:-0}" != "1" ]; then
  echo ""
  echo "ERROR: $deleted_lines lines deleted in staged changes (threshold: $MAX_DELETIONS)."
  echo ""
  echo "This looks like an accidental mass deletion. Please verify:"
  echo "  git diff --cached --stat"
  echo ""
  echo "To proceed anyway:  ALLOW_LARGE_COMMIT=1 git commit ..."
  echo ""
  exit 1
fi

# ‚îÄ‚îÄ Gitleaks: secrets detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#
# Scans staged files for hardcoded secrets (API keys, tokens, passwords).
# Install: brew install gitleaks   OR   https://github.com/gitleaks/gitleaks
# Skip:    SKIP_SECRETS_SCAN=1 git commit ...
#
if [ "${SKIP_SECRETS_SCAN:-0}" != "1" ]; then
  if command -v gitleaks &>/dev/null; then
    echo "üîç Scanning staged files for secrets (gitleaks)..."
    if ! gitleaks protect --staged --no-banner --exit-code 1 2>/dev/null; then
      echo ""
      echo "ERROR: Gitleaks detected potential secrets in staged files."
      echo ""
      echo "Review the findings above and either:"
      echo "  1. Remove the secret and use an environment variable instead"
      echo "  2. Add a .gitleaksignore entry if it is a false positive"
      echo "  3. Skip scan (NOT recommended): SKIP_SECRETS_SCAN=1 git commit ..."
      echo ""
      exit 1
    fi
    echo "‚úÖ No secrets detected."
  else
    echo "‚ö†Ô∏è  gitleaks not installed ‚Äî secrets scan skipped."
    echo "   Install: brew install gitleaks"
  fi
fi

# ‚îÄ‚îÄ actionlint: GitHub Actions workflow validation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#
# Validates staged .github/workflows/*.yml files for syntax errors and
# expression injection vulnerabilities.
# Install: brew install actionlint   OR   https://github.com/rhysd/actionlint
# Skip:    SKIP_ACTIONLINT=1 git commit ...
#
if [ "${SKIP_ACTIONLINT:-0}" != "1" ]; then
  staged_workflows=$(git diff --cached --name-only | grep -E '^\.github/workflows/.*\.ya?ml$' || true)
  if [ -n "$staged_workflows" ] && command -v actionlint &>/dev/null; then
    echo "üîç Validating GitHub Actions workflows (actionlint)..."
    # shellcheck disable=SC2086
    if ! actionlint $staged_workflows 2>/dev/null; then
      echo ""
      echo "ERROR: actionlint found issues in staged workflow files."
      echo "Fix the issues above or skip: SKIP_ACTIONLINT=1 git commit ..."
      echo ""
      exit 1
    fi
    echo "‚úÖ Workflow files valid."
  elif [ -n "$staged_workflows" ]; then
    echo "‚ö†Ô∏è  actionlint not installed ‚Äî workflow validation skipped."
    echo "   Install: brew install actionlint"
  fi
fi
