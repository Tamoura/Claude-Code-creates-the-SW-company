name: Security Scanning

# Runs on every PR and every push to main.
# All SARIF results upload to the GitHub Security tab.
#
# Jobs:
#   codeql          — deep semantic SAST (required status check)
#   semgrep         — pattern SAST: nodejs, typescript, owasp-top-ten, jwt, secrets
#   secrets-history — TruffleHog full git history + live credential verification
#   secrets-staged  — Gitleaks incremental scan (PRs only)
#   actionlint      — GitHub Actions expression injection detection
#   trivy           — SCA + IaC + Dockerfile scanning
#   dependency-audit— pnpm audit across all products (critical severity)

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ── 1. CodeQL — deep semantic SAST ─────────────────────────────────────
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: '/language:javascript-typescript'

  # ── 2. Semgrep — pattern SAST (BLOCKING) ───────────────────────────────
  # Findings at error/warning level block the PR — no more continue-on-error.
  # Rationale: Semgrep p/owasp-top-ten catches real injection + XSS patterns.
  # False positives should be suppressed with # nosemgrep inline comments,
  # not by downgrading the entire job to advisory.
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep (blocking)
        run: |
          semgrep \
            --config p/nodejs \
            --config p/typescript \
            --config p/owasp-top-ten \
            --config p/jwt \
            --config p/secrets \
            --sarif \
            --output semgrep.sarif \
            --exclude node_modules \
            --exclude dist \
            --exclude build \
            --exclude coverage \
            --exclude pnpm-lock.yaml \
            --exclude "*.min.js" \
            --error \
            .

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
          category: semgrep
        if: always()

      - name: Comment PR with findings
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let sarif;
            try { sarif = JSON.parse(fs.readFileSync('semgrep.sarif', 'utf8')); }
            catch { return; }
            const results = (sarif.runs || []).flatMap(r => r.results || []);
            const high = results.filter(r => ['error','warning'].includes(r.level));
            if (high.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '## Semgrep SAST\n\n✅ No findings detected.'
              });
              return;
            }
            const lines = high.slice(0, 15).map(r => {
              const loc = r.locations?.[0]?.physicalLocation;
              const file = loc?.artifactLocation?.uri || 'unknown';
              const line = loc?.region?.startLine || '?';
              return `- \`${file}:${line}\` — ${r.message?.text || ''}`;
            });
            const more = high.length > 15 ? `\n\n…and ${high.length - 15} more.` : '';
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Semgrep SAST — ${high.length} finding(s)\n\n${lines.join('\n')}${more}\n\nSee the Security tab for full details.`
            });

  # ── 3. TruffleHog — full history secrets scan ──────────────────────────
  secrets-history:
    name: TruffleHog (Full History)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true

  # ── 4. Gitleaks — incremental PR secrets scan ──────────────────────────
  secrets-staged:
    name: Gitleaks (PR Diff)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks on PR diff
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ── 5. actionlint — GitHub Actions security analysis ───────────────────
  actionlint:
    name: actionlint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run actionlint
        uses: rhysd/actionlint@v1
        with:
          flags: "-color"
        continue-on-error: true

  # ── 6. Trivy — SCA + IaC + Dockerfile (CRITICAL=blocking, HIGH=advisory)
  # CRITICAL vulnerabilities block PRs. HIGH severity uploads to Security tab
  # but does not block — reduces noise while catching the most severe issues.
  trivy:
    name: Trivy (SCA + IaC)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy (CRITICAL — blocking)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: CRITICAL
          skip-dirs: node_modules,dist,build,coverage,.git
          ignore-unfixed: true
          exit-code: '1'

      - name: Run Trivy (HIGH — SARIF upload, advisory)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy.sarif
          severity: CRITICAL,HIGH
          skip-dirs: node_modules,dist,build,coverage,.git
          ignore-unfixed: true
        if: always()

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy.sarif
          category: trivy
        if: always()

  # ── 7. Dependency audit — pnpm audit across workspace ──────────────────
  dependency-audit:
    name: Dependency Audit (pnpm)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: |
          echo "Running pnpm audit across workspace..."
          pnpm audit --audit-level=critical --prod 2>&1 || {
            echo "::error::Critical vulnerability found in workspace dependencies."
            exit 1
          }
          echo "pnpm audit complete — no critical vulnerabilities found."
