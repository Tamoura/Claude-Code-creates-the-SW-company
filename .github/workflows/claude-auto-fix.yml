name: Claude Auto-Fix Bug

on:
  issues:
    types: [labeled]

jobs:
  auto-fix:
    # Only trigger when both 'bug' and 'auto-fix' labels are present
    if: |
      github.event.label.name == 'auto-fix' &&
      contains(toJSON(github.event.issue.labels.*.name), 'bug')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create fix branch
        id: branch
        run: |
          BRANCH_NAME="fix/auto/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

      - name: Run Claude Code to analyze and fix
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are a bug-fix agent for the ConnectSW codebase.

            Analyze the following GitHub issue and attempt to fix it.

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            Issue body:
            ${{ github.event.issue.body }}

            Instructions:
            1. Read the issue carefully and identify the root cause.
            2. Find the relevant files in the codebase.
            3. Implement a minimal, focused fix. Do NOT refactor unrelated code.
            4. Run any existing tests to verify the fix does not break anything.
            5. If tests exist for the affected area, ensure they pass.
            6. Follow the project conventions in CLAUDE.md (TypeScript, conventional commits).
            7. Stage and commit only the files you changed using specific file names (never git add . or git add -A).
            8. Use commit message format: fix(<scope>): <description> (Closes #${{ github.event.issue.number }})

      - name: Push branch and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if any commits were made by Claude
          if git log --oneline origin/main..HEAD | grep -q .; then
            git push origin "${{ steps.branch.outputs.branch_name }}"
            gh pr create \
              --title "fix: auto-fix for issue #${{ github.event.issue.number }}" \
              --body "$(cat <<'EOF'
          ## Automated Bug Fix

          This PR was automatically generated by Claude Code in response to issue #${{ github.event.issue.number }}.

          **Issue:** ${{ github.event.issue.title }}

          ## Safety Gate

          - [ ] **Manual review required** â€” this is an AI-generated fix
          - [ ] Verify the fix addresses the root cause
          - [ ] Confirm no unintended side effects
          - [ ] Tests pass in CI

          > This PR requires manual approval before merge. Do NOT auto-merge.

          Closes #${{ github.event.issue.number }}
          EOF
          )" \
              --label "auto-fix,needs-review"
          else
            gh issue comment ${{ github.event.issue.number }} \
              --body "Claude Code was unable to produce a fix for this issue. Manual investigation is required."
          fi
