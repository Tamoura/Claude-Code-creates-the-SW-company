name: ArchForge CI

on:
  pull_request:
    paths:
      - 'products/archforge/**'
      - '.github/workflows/archforge-ci.yml'
  push:
    branches: [main]
    paths:
      - 'products/archforge/**'

jobs:
  api-lint-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm
      - name: Install API deps
        run: archforge/apps/api 
      - name: Generate Prisma client
        run: archforge/apps/api && npx prisma generate
      - name: TypeScript check
        run: archforge/apps/api && npx tsc --noEmit
      - name: Lint
        run: pnpm run lint
        working-directory: products/archforge/apps/api || true

  api-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: archforge_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm
      - name: Install API deps
        run: archforge/apps/api 
      - name: Generate Prisma client
        run: archforge/apps/api && npx prisma generate
      - name: Run migrations
        run: archforge/apps/api && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/archforge_test
      - name: Run tests with coverage
        run: pnpm run test:coverage
        working-directory: products/archforge/apps/api -- --forceExit
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/archforge_test
          JWT_SECRET: ci-test-jwt-secret-key-for-testing-only
          OPENROUTER_API_KEY: test-key
          INTERNAL_API_KEY: test-internal-api-key
          NODE_ENV: test
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: api-coverage
          path: products/archforge/apps/api/coverage/

  web-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm
      - name: Install Web deps
        run: archforge/apps/web 
      - name: TypeScript check
        run: archforge/apps/web && npx tsc --noEmit
      - name: Build
        run: pnpm run build
        working-directory: products/archforge/apps/web
        env:
          NEXT_PUBLIC_API_URL: http://localhost:5012

  smoke-test:
    needs: [api-test, web-build]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: archforge_smoke
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm
      - name: Install API deps
        run: archforge/apps/api 
      - name: Generate Prisma + migrate
        run: archforge/apps/api && npx prisma generate && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/archforge_smoke
      - name: Start API server
        run: pnpm run dev
        working-directory: products/archforge/apps/api &
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/archforge_smoke
          JWT_SECRET: ci-smoke-jwt-secret-key-for-testing
          OPENROUTER_API_KEY: test-key
          INTERNAL_API_KEY: test-internal-api-key
          PORT: 5012
      - name: Wait for API
        run: |
          for i in $(seq 1 30); do
            curl -sf http://localhost:5012/health && exit 0
            sleep 1
          done
          exit 1
      - name: Run smoke tests
        run: |
          # Health check
          curl -sf http://localhost:5012/health | jq .status

          # Register a user
          REGISTER=$(curl -sf -X POST http://localhost:5012/api/v1/auth/register \
            -H "Content-Type: application/json" \
            -d '{"email":"smoke@test.com","password":"SmokeTest123!@#","fullName":"Smoke Tester"}')
          echo "Register: $REGISTER"

          # Check response
          echo "$REGISTER" | jq .userId
