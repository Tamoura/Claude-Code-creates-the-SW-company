# Bug Fix Workflow Task Graph Template
# Placeholders: {PRODUCT}, {BUG_DESCRIPTION}, {ISSUE_ID}
#
# TRACEABILITY RULES (Constitution Article VI):
#   - Bug must be linked to affected user story (US-XX) and requirement (FR-XXX)
#   - Commits MUST include #{ISSUE_ID} and affected [US-XX] / [FR-XXX]
#   - Regression tests MUST reference the affected acceptance criteria
#   - PR description MUST list: issue, affected stories, root cause

metadata:
  product: "{PRODUCT}"
  version: "2.0.0"
  workflow_type: "bug-fix"
  issue_id: "{ISSUE_ID}"
  fast_track: true
  skip_steps: ["3.3", "3.7"]
  created_at: "{TIMESTAMP}"
  updated_at: "{TIMESTAMP}"
  traceability:
    brd_ref: "products/{PRODUCT}/docs/PRD.md"
    issue_ref: "#{ISSUE_ID}"
    affected_story_ids: ["{AFFECTED_STORY_IDS}"]
    affected_requirement_ids: ["{AFFECTED_REQUIREMENT_IDS}"]

tasks:
  # ============================================================================
  # PHASE 1: TRIAGE & INVESTIGATION
  # ============================================================================

  - id: "BUG-01"
    name: "Triage and Reproduce Bug"
    description: |
      Bug reported: {BUG_DESCRIPTION}

      Your tasks:
      1. Attempt to reproduce the bug
      2. Identify affected component (backend/frontend/infra)
      3. Assess severity (critical/high/medium/low)
      4. IDENTIFY ALL RELATED FUNCTIONALITY (not just the bug)
      5. Document reproduction steps
      6. Create GitHub issue if not exists

      IMPORTANT: Don't just focus on the reported bug - identify ALL
      related parameters, fields, and features that should be tested.
    agent: "support-engineer"
    depends_on: []
    produces:
      - name: "Bug Investigation Report"
        type: "document"
        path: "products/{PRODUCT}/docs/bugs/{ISSUE_ID}-investigation.md"
      - name: "GitHub Issue"
        type: "url"
        path: "#{ISSUE_ID}"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "high"
    estimated_time_minutes: 30
    acceptance_criteria:
      - "Bug reproduced with clear steps"
      - "Severity assessed"
      - "Affected component identified"
      - "ALL related functionality documented"
      - "GitHub issue created/updated"
    status: "pending"

  # ============================================================================
  # PHASE 2: USER STORIES & TEST PLANNING (MANDATORY)
  # ============================================================================

  - id: "BUG-02"
    name: "Create User Stories for ALL Related Functionality"
    description: |
      Create comprehensive user stories:
      - Story for the specific bug
      - Stories for ALL related parameters/fields
      - Stories for edge cases

      Example: If bug is "GPU count doesn't update", create stories for:
      - GPU count field
      - ALL other form fields (modelSizeB, datasetSizeGb, etc.)
      - Calculation behavior
      - Results display

      Document in: products/{PRODUCT}/docs/TEST-PLAN-{ISSUE_ID}.md

      Format:
      - As a [user], when I [action], I expect [result]
      - Given/When/Then acceptance criteria
    agent: "support-engineer"
    depends_on: ["BUG-01"]
    consumes:
      - name: "Bug Investigation Report"
        required_from_task: "BUG-01"
    produces:
      - name: "Test Plan with User Stories"
        type: "document"
        path: "products/{PRODUCT}/docs/TEST-PLAN-{ISSUE_ID}.md"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "high"
    estimated_time_minutes: 30
    acceptance_criteria:
      - "User stories for ALL related functionality created"
      - "Each story has Given/When/Then criteria"
      - "Edge cases identified"
      - "Test plan documented"
    status: "pending"

  # ============================================================================
  # PHASE 3: WRITE TESTS FIRST (TDD - MANDATORY)
  # ============================================================================

  - id: "BUG-03"
    name: "Write Failing Tests (Before Fix)"
    description: |
      TDD approach - write tests BEFORE fixing:

      1. Create fix branch: fix/{PRODUCT}/{ISSUE_ID}

      2. Write unit tests that MUST FAIL:
         - Test reproducing the exact bug
         - Tests for ALL related parameters (from user stories)
         - Edge case tests (0, negative, max values, etc.)

      3. Write E2E test that reproduces bug scenario

      4. Run tests → Verify they FAIL

      5. Commit: "test: add failing tests for #{ISSUE_ID}"

      DO NOT fix the bug yet!
    agent: "{ASSIGNED_AGENT}"
    depends_on: ["BUG-02"]
    consumes:
      - name: "Test Plan with User Stories"
        required_from_task: "BUG-02"
    produces:
      - name: "Unit Tests"
        type: "file"
        path: "products/{PRODUCT}/apps/{APP}/tests/{COMPONENT}.test.ts"
      - name: "E2E Tests"
        type: "file"
        path: "products/{PRODUCT}/e2e/tests/bugs/{ISSUE_ID}.spec.ts"
      - name: "Fix Branch"
        type: "branch"
        path: "fix/{PRODUCT}/{ISSUE_ID}"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 45
    acceptance_criteria:
      - "Tests created for the bug AND all related functionality"
      - "All new tests FAIL when run"
      - "Tests are committed to branch"
      - "Test coverage includes edge cases"
    status: "pending"

  # ============================================================================
  # PHASE 4: IMPLEMENT FIX
  # ============================================================================

  - id: "BUG-04"
    name: "Implement Bug Fix"
    description: |
      Now implement the fix:

      1. Write MINIMAL code to make failing tests pass
      2. No extra refactoring (unless necessary for fix)
      3. Run tests → Verify they PASS
      4. Run ALL tests (full suite) → Must all pass
      5. Commit: "fix: resolve {BUG_DESCRIPTION} #{ISSUE_ID}"

      If any regression tests fail, fix them before proceeding.
    agent: "{ASSIGNED_AGENT}"
    depends_on: ["BUG-03"]
    consumes:
      - name: "Unit Tests"
        required_from_task: "BUG-03"
      - name: "E2E Tests"
        required_from_task: "BUG-03"
    produces:
      - name: "Bug Fix Code"
        type: "file"
        path: "products/{PRODUCT}/apps/{APP}/src/{COMPONENT}"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 60
    acceptance_criteria:
      - "All new tests now pass"
      - "All existing tests still pass (no regressions)"
      - "Fix is minimal and focused"
      - "Code committed with proper message"
    status: "pending"

  # ============================================================================
  # PHASE 5: QA VERIFICATION
  # ============================================================================

  - id: "BUG-05"
    name: "QA Verification of Fix"
    description: |
      Comprehensive verification:

      1. Run all unit tests
      2. Run all E2E tests
      3. Manually verify bug is fixed
      4. Test ALL related functionality (not just the bug)
      5. Visual verification if UI change
      6. Check for any side effects
      7. Update test report
    agent: "qa-engineer"
    depends_on: ["BUG-04"]
    consumes:
      - name: "Bug Fix Code"
        required_from_task: "BUG-04"
    produces:
      - name: "QA Verification Report"
        type: "document"
        path: "products/{PRODUCT}/docs/bugs/{ISSUE_ID}-verification.md"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "high"
    estimated_time_minutes: 30
    acceptance_criteria:
      - "All tests pass"
      - "Bug is fixed and verified"
      - "No regressions detected"
      - "All related functionality works"
      - "Report documents verification"
    status: "pending"

  # ============================================================================
  # PHASE 6: PR & CHECKPOINT (for High/Critical bugs)
  # ============================================================================

  - id: "BUG-06"
    name: "Create Pull Request"
    description: |
      Create PR for the fix:

      1. Create PR: fix/{PRODUCT}/{ISSUE_ID} → main
      2. PR description includes:
         - Summary of bug
         - Root cause
         - Fix description
         - Test coverage (list tests added)
         - Link to issue
      3. Ensure CI passes
    agent: "{ASSIGNED_AGENT}"
    depends_on: ["BUG-05"]
    produces:
      - name: "Pull Request"
        type: "pr"
        path: "#{PR_NUMBER}"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "high"
    estimated_time_minutes: 15
    acceptance_criteria:
      - "PR created with complete description"
      - "CI build passes"
      - "All checks green"
    status: "pending"

  - id: "CHECKPOINT-REVIEW"
    name: "Bug Fix Ready for Review"
    description: |
      Bug fix is complete and tested.

      For Critical/High severity bugs: CEO review required
      For Medium/Low severity bugs: Can be auto-merged

      Summary:
      - Bug: {BUG_DESCRIPTION}
      - Severity: {SEVERITY}
      - Tests added: {TEST_COUNT}
      - All tests passing: Yes
      - PR: #{PR_NUMBER}
    agent: "orchestrator"
    depends_on: ["BUG-06"]
    parallel_ok: false
    checkpoint: true
    priority: "{SEVERITY}"
    estimated_time_minutes: 0
    status: "pending"

# Execution estimates:
# - Total time: ~210 minutes (~3.5 hours) for thorough bug fix
# - Fast track (low severity): ~90 minutes with less verification
