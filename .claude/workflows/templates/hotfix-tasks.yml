# Hotfix Workflow Task Graph Template
# Placeholders: {PRODUCT}, {HOTFIX_ID}, {ISSUE}, {DESCRIPTION}, {SEVERITY}, {TIMESTAMP}
# Use for: Production bugs that need immediate fixes

# ─────────────────────────────────────────────────────────────────
# PROTOCOL ENFORCEMENT (ConnectSW Constitution Articles XI & XII)
# ─────────────────────────────────────────────────────────────────
# ALL AGENTS must follow BEFORE starting any task:
#   - Read .claude/protocols/anti-rationalization.md (Article XI)
#   - Apply the 1% Rule: if a quality step might apply, invoke it
#
# ALL AGENTS must follow BEFORE marking any task done:
#   - Verification-Before-Completion 5-Step Gate (Article XI):
#     1. Identify what "done" looks like (specific, testable)
#     2. Execute the actual verification command
#     3. Read the actual output (do NOT assume success)
#     4. Compare output to acceptance criteria literally
#     5. Claim done only when evidence matches
#
# FOR DELIVERABLES (Article XII):
#   - Write all outputs to files (direct-delivery.md)
#   - Compress context if >60% full (context-compression.md)
# ─────────────────────────────────────────────────────────────────

# CONSTITUTION REFERENCE: .specify/memory/constitution.md (v1.3.0)
# Key articles for bug fixes:
#   Article III (TDD): Add a failing test that reproduces the bug FIRST
#   Article VIII (Git Safety): Never git add . — stage specific files
#   Article XI (Anti-Rationalization): "I'll add tests after" is forbidden
#   Article XI (Verification): Bug fix is NOT done until the bug is provably gone

metadata:
  product: "{PRODUCT}"
  hotfix_id: "{HOTFIX_ID}"
  issue: "{ISSUE}"
  severity: "{SEVERITY}"
  workflow_type: "hotfix"
  fast_track: true
  skip_steps: ["3.3", "3.7"]
  # Note: Step 3.5 (memory injection) is intentionally NOT skipped.
  # Hotfixes benefit most from institutional knowledge (known pitfalls,
  # past failures, anti-patterns). Step 3.3 (backlog) and 3.7 (estimates)
  # are skipped for speed.
  created_at: "{TIMESTAMP}"
  updated_at: "{TIMESTAMP}"

tasks:
  # ============================================================================
  # PHASE 1: INVESTIGATION (Fast-track)
  # ============================================================================

  - id: "INVESTIGATE-{HOTFIX_ID}"
    name: "Investigate Issue: {ISSUE}"
    description: |
      URGENT: Investigate production issue
      
      Issue: {DESCRIPTION}
      Severity: {SEVERITY}
      
      Tasks:
      - Review error logs
      - Identify root cause
      - Determine scope of impact
      - Document reproduction steps
      - Propose fix approach
    agent: "support-engineer"
    depends_on: []
    produces:
      - name: "Investigation Report"
        type: "document"
        path: "products/{PRODUCT}/docs/hotfixes/{HOTFIX_ID}-investigation.md"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 30
    acceptance_criteria:
      - "Root cause identified"
      - "Reproduction steps documented"
      - "Fix approach proposed"
      - "Impact scope understood"
    status: "pending"

  # ============================================================================
  # PHASE 2: FIX IMPLEMENTATION
  # ============================================================================

  - id: "FIX-{HOTFIX_ID}"
    name: "Implement Fix for {ISSUE}"
    description: |
      Implement the hotfix:
      - Create hotfix branch from production
      - Write failing test that reproduces bug
      - Implement minimal fix
      - Ensure test passes
      - Keep changes minimal and focused
    agent: "backend-engineer"
    depends_on: ["INVESTIGATE-{HOTFIX_ID}"]
    consumes:
      - name: "Investigation Report"
        required_from_task: "INVESTIGATE-{HOTFIX_ID}"
    produces:
      - name: "Hotfix Implementation"
        type: "branch"
        path: "hotfix/{PRODUCT}/{HOTFIX_ID}"
      - name: "Regression Test"
        type: "file"
        path: "products/{PRODUCT}/apps/api/tests/hotfix-{HOTFIX_ID}.test.ts"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 60
    acceptance_criteria:
      - "Hotfix branch created"
      - "Regression test written"
      - "Fix implemented"
      - "Test passes"
      - "Minimal code changes"
    status: "pending"

  # ============================================================================
  # PHASE 3: VERIFICATION
  # ============================================================================

  - id: "VERIFY-{HOTFIX_ID}"
    name: "Verify Hotfix"
    description: |
      Verify the hotfix:
      - Run all existing tests
      - Run regression test
      - Verify fix on local environment
      - Check for side effects
    agent: "qa-engineer"
    depends_on: ["FIX-{HOTFIX_ID}"]
    produces:
      - name: "Verification Report"
        type: "document"
        path: "products/{PRODUCT}/docs/hotfixes/{HOTFIX_ID}-verification.md"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 30
    acceptance_criteria:
      - "All existing tests pass"
      - "Regression test passes"
      - "Fix verified locally"
      - "No side effects detected"
    status: "pending"

  # ============================================================================
  # PHASE 4: CEO APPROVAL (Emergency)
  # ============================================================================

  - id: "CHECKPOINT-{HOTFIX_ID}"
    name: "Hotfix Ready - CEO Approval"
    description: |
      URGENT: Hotfix {HOTFIX_ID} ready for production deployment
      
      Issue: {ISSUE}
      Severity: {SEVERITY}
      
      Status:
      - ✅ Root cause identified
      - ✅ Fix implemented
      - ✅ Regression test added
      - ✅ All tests passing
      - ✅ Verified locally
      
      Awaiting CEO approval for production deployment.
      
      ⚠️ This is a hotfix - minimal changes only, focused on fixing the issue.
    agent: "orchestrator"
    depends_on: ["VERIFY-{HOTFIX_ID}"]
    parallel_ok: false
    checkpoint: true
    priority: "critical"
    estimated_time_minutes: 0
    status: "pending"

  # ============================================================================
  # PHASE 5: EMERGENCY DEPLOYMENT
  # ============================================================================

  - id: "DEPLOY-{HOTFIX_ID}"
    name: "Deploy Hotfix to Production"
    description: |
      Emergency deployment:
      - Deploy hotfix to production
      - Verify fix is active
      - Monitor for any issues
      - Keep rollback ready
    agent: "devops-engineer"
    depends_on: ["CHECKPOINT-{HOTFIX_ID}"]
    produces:
      - name: "Deployment Log"
        type: "document"
        path: "products/{PRODUCT}/docs/hotfixes/{HOTFIX_ID}-deployment.md"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 15
    acceptance_criteria:
      - "Hotfix deployed to production"
      - "Issue resolved in production"
      - "No new errors introduced"
    status: "pending"

  - id: "MONITOR-{HOTFIX_ID}"
    name: "Monitor Hotfix"
    description: |
      Monitor production after hotfix:
      - Watch error logs for 30 minutes
      - Verify issue is resolved
      - Check for any side effects
      - Report results
    agent: "support-engineer"
    depends_on: ["DEPLOY-{HOTFIX_ID}"]
    produces:
      - name: "Monitoring Report"
        type: "document"
        path: "products/{PRODUCT}/docs/hotfixes/{HOTFIX_ID}-monitoring.md"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "critical"
    estimated_time_minutes: 30
    acceptance_criteria:
      - "No errors in logs"
      - "Issue confirmed resolved"
      - "No side effects observed"
    status: "pending"

  # ============================================================================
  # PHASE 6: CLEANUP
  # ============================================================================

  - id: "CLEANUP-{HOTFIX_ID}"
    name: "Hotfix Cleanup"
    description: |
      Complete hotfix process:
      - Merge hotfix to main branch
      - Update version if needed
      - Close related issues
      - Document lessons learned
    agent: "devops-engineer"
    depends_on: ["MONITOR-{HOTFIX_ID}"]
    produces:
      - name: "Hotfix Complete"
        type: "document"
        path: "products/{PRODUCT}/docs/hotfixes/{HOTFIX_ID}-complete.md"
    context_output: ""
    parallel_ok: false
    checkpoint: false
    priority: "high"
    estimated_time_minutes: 15
    acceptance_criteria:
      - "Hotfix merged to main"
      - "Issue closed"
      - "Lessons documented"
    status: "pending"

  - id: "COMPLETE-{HOTFIX_ID}"
    name: "Hotfix Complete - Summary"
    description: |
      Hotfix {HOTFIX_ID} is complete.
      
      Issue: {ISSUE}
      Resolution: Fixed and deployed to production
      
      The issue has been resolved and production is stable.
    agent: "orchestrator"
    depends_on: ["CLEANUP-{HOTFIX_ID}"]
    parallel_ok: false
    checkpoint: true
    priority: "normal"
    estimated_time_minutes: 0
    status: "pending"

# Execution estimates:
# - Total time: ~180 minutes (~3 hours)
# - CEO approval points: 1 (before production deploy)
# - Designed for speed - minimal checkpoints
